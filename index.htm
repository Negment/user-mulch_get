<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title></title> 
  
  <style>
    body {
      margin: 0;
      font-family: "Helvetica Neue", "Helvetica", Arial, sans-serif;
      color: #000;
      line-height: 1.5em;
      font-size: 16px;
      background-color: white; 
    }

    #container {
      width: auto;
      margin: 0;
      padding: 10px;
    }

    #result-output {
      /* 結果が出るまで完全に非表示 */
      white-space: pre-wrap;
      padding: 0;
      border: none;
      background-color: transparent;
      color: #000;
      display: none; 
      font-family: monospace; 
    }
    
    /* デバッグログ専用のスタイル */
    #debug-log {
      margin-top: 20px;
      padding-top: 10px;
      border-top: 1px solid #ccc;
      white-space: pre-wrap;
      font-size: 14px;
      color: #777;
    }
    .error-log {
      color: red;
      font-weight: bold;
    }
    .json-log {
      font-size: 12px;
      color: #005500;
      font-family: monospace;
      margin: 5px 0;
      padding: 3px;
      border: 1px dotted #ccc;
    }
    
    #profile-image { display: none; }
  </style>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>
<body>
  <div id="container">
    <p id="result-output"></p> 
    <p id="debug-log"></p> 
  </div>

  <script>
"use strict";

const VERSION = "5.0.10"; // 臨時バージョン番号を更新
const TURBOWARP_USER_PROXY_BASE = 'https://trampoline.turbowarp.org/proxy/users/';
const TURBOWARP_PROJECT_PROXY_BASE = 'https://trampoline.turbowarp.org/proxy/projects/';
const SCRATCH_API_PROJECT_BASE = 'https://api.scratch.mit.edu/projects/'; // メタデータ API
const $output = $('#result-output');
const $debugLog = $('#debug-log');

// --- 定数/ステータス ---
const STATUS_SUCCESS = 'Success';
const STATUS_NOT_FOUND = 'Resource does not exist';
const STATUS_INVALID = 'Invalid username'; 
const STATUS_INVALID_PROJECT = 'Invalid project ID';
const STATUS_ERROR = 'Error';
const STATUS_NO_INPUT = 'No input';
const STATUS_NOT_REGISTERED = 'Account not registered'; // 内部でのみ使用
const STATUS_ACCOUNT_INVALID = 'Account invalid'; // 内部でのみ使用

// --- ヘルパー関数 ---

function logToScreen(message, isError = false) {
    const className = isError ? 'error-log' : '';
    $debugLog.append(`<span class="${className}">[${new Date().toLocaleTimeString()}] ${message}</span><br>`);
}

function logJson(label, data) {
    let jsonString = '';
    try {
        jsonString = JSON.stringify(data, null, 2);
    } catch(e) {
        jsonString = '--- JSON serialization error ---';
    }
    $debugLog.append(`<div class="json-log"><strong>${label}:</strong><pre>${jsonString}</pre></div>`);
}

/**
 * URLクエリパラメータから username と projectId を取得する
 */
function getQueryParameters() {
    const urlParams = new URLSearchParams(window.location.search);
    return {
        username: urlParams.get('username') ? urlParams.get('username').trim() : null,
        projectId: urlParams.get('projectId') ? urlParams.get('projectId').trim() : null
    };
}

/**
 * JSONライクな文字列出力
 */
function jsonToScratchString(obj) {
    let parts = [];
    for (const key in obj) {
        if (!obj.hasOwnProperty(key)) continue;
        const value = typeof obj[key] === 'string' 
            ? `"${obj[key].replace(/\\/g, '\\\\').replace(/"/g, '\\"')}"` 
            : obj[key];
        
        parts.push(`"${key}":${value}`);
    }
    return `{${parts.join(',')}}`;
}

/**
 * 結果を出力エリアに表示する
 */
function displayResult(result) {
    logToScreen('[DEBUG] Attempting to display result.'); 
    if (typeof result === 'string') {
        $output.text(result);
    } else {
        // FATAL JSON ERROR回避のためtry-catchを追加
        try {
            $output.html(jsonToScratchString(result));
        } catch (e) {
            logToScreen('FATAL ERROR: Could not format/display JSON. ' + e.message, true);
            $output.text('FATAL JSON ERROR');
        }
    }
    $output.css('display', 'block');
    logToScreen('[END] Output successful.');
}

/**
 * ユーザーAPIからデータを取得する
 */
function getUserData(username) {
    logToScreen(`1. Fetching User Data for: ${username}`);
    return $.ajax({
        url: TURBOWARP_USER_PROXY_BASE + username,
        dataType: 'json',
    })
    .then(function(userData) {
        logJson('User Proxy Response', userData); // JSONログ追加
        if (userData.error === 'Resource does not exist' || userData.error === 'NotFound') {
            return { status: STATUS_NOT_FOUND, data: null };
        }
        if (userData.error === 'Invalid username') {
            return { status: STATUS_INVALID, data: null };
        }
        return { 
            status: STATUS_SUCCESS, 
            data: {
                username: userData.username,
                id: userData.id,
                joined: userData.history.joined ? new Date(userData.history.joined).toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-') : '',
                country: userData.profile.country || '',
                images: userData.profile.images['90x90'] ? userData.profile.images['90x90'].split('?')[0] : '',
            }
        };
    })
    .catch(function(reason) {
        // API通信エラーや、jQueryのタイムアウトエラーなど
        logToScreen(`1. User API failed for ${username}`, true);
        // 存在しないアカウントの場合もこのcatchに入ることがあるため、便宜上STATUS_NOT_FOUNDにフォールバック
        // (APIが404を返す場合、jQueryがエラーを投げることが多いため)
        return { status: STATUS_NOT_FOUND, data: null }; 
    });
}

/**
 * プロジェクトJSONからメタデータを取得する (Proxyデータ優先抽出)
 */
async function getProjectMetaData(projectId) {
    logToScreen(`2. Fetching Project Meta Data for ID: ${projectId} (Proxy/JSON Check)`);
    
    let authorUsername = null;
    let projectIdInJson = null;
    let title = null;
    let status = STATUS_ERROR;
    let projectJsonText = null;

    try {
        // 1. プロジェクトのトークンとメタデータを Proxy から取得
        const tokenData = await $.ajax({
            url: TURBOWARP_PROJECT_PROXY_BASE + projectId,
            dataType: "json",
        });
        
        logJson('Project Proxy Response (Token Data)', tokenData); // JSONログ追加

        // 2. エラーチェックを tokenData 取得直後に行い、statusを確定させる
        if (tokenData.error) {
            if (tokenData.error === 'Resource does not exist' || tokenData.error === 'NotFound') {
                status = STATUS_NOT_FOUND;
            } else if (tokenData.error === 'Invalid project ID') {
                status = STATUS_INVALID_PROJECT; 
            }
            // throwせずに、確定したstatusとnullデータを返却
            return { status: status, data: null }; 
        }
        
        // 3. Proxyレスポンスから作者名があれば即時リターン
        if (tokenData.author && tokenData.author.username) {
            authorUsername = tokenData.author.username;
            projectIdInJson = tokenData.id || projectIdInJson;
            title = tokenData.title || title;
            status = STATUS_SUCCESS;
            logToScreen('2b. Successfully extracted author from Proxy Metadata.');
            
            return {
                data: {
                    author: authorUsername,
                    id: projectIdInJson,
                    title: title,
                    visibility: tokenData.visibility || 'visible', 
                },
                status: status
            };
        }
        
        logToScreen('2b. Author not found in Proxy Metadata. Proceeding to Full JSON check.');
        
        // 4. Proxyに作者名がなかった場合、フルJSONをダウンロード
        let token = tokenData["project_token"];
        projectJsonText = await $.ajax({
            url: `https://projects.scratch.mit.edu/${projectId}/?token=${token}`,
            dataType: "text",
        });

        logJson('Project Full JSON Text (Raw)', projectJsonText.substring(0, 500) + '...'); // JSONログ追加（長すぎるため一部のみ）

        // 5. JSON.parse() を試みる (フルJSONからの抽出)
        try {
            const projectJson = JSON.parse(projectJsonText);
            if (projectJson && projectJson.author && projectJson.author.username) {
                authorUsername = projectJson.author.username;
                projectIdInJson = projectJson.id || projectIdInJson;
                title = projectJson.title || title;
                status = STATUS_SUCCESS;
                logToScreen('2c. Successfully extracted author via Full JSON.parse().');
            } else {
                 // author情報がなかった場合、エラーをスローしてcatchに移行し、正規表現ロジックへ強制移行
                logToScreen('2c. Full JSON parse succeeded but author field was missing/null. Forcing regex fallback.', true);
                throw new Error("Author field missing after JSON parse.");
            }
        } catch(parseError) {
             // 6. JSON.parse() が失敗したか、authorフィールドがなかった場合、正規表現による抽出を試みる
             logToScreen('2d. JSON parse failed or author missing. Trying regex fallback.', true);

            const authorUsernameRegex = /"author":\s*\{[^}]*?"username"\s*:\s*"([^"]+)"/s; 
            const idRegex = /"id"\s*:\s*(\d+)/;
            const titleRegex = /"title"\s*:\s*"(.+?)"/s;

            const authorMatch = projectJsonText.match(authorUsernameRegex);
            const idMatch = projectJsonText.match(idRegex);
            const titleMatch = projectJsonText.match(titleRegex);

            authorUsername = authorMatch ? authorMatch[1] : null; 
            projectIdInJson = idMatch ? idMatch[1] : null;
            title = titleMatch ? titleMatch[1] : null;

            if (authorUsername) {
                logToScreen('2e. Successfully extracted author via regex fallback.');
                status = STATUS_SUCCESS;
            } else {
                logToScreen('2e. Regex fallback also failed.', true);
            }
        }
        
        if (authorUsername) {
            // フルJSONルートで成功した場合のリターン
            return {
                data: {
                    author: authorUsername,
                    id: projectIdInJson,
                    title: title,
                    visibility: 'visible',
                },
                status: STATUS_SUCCESS // 成功状態を確定
            };
        }

    } catch(e) {
        // ここに来るのは API通信エラーや フルJSONダウンロード失敗時など。
        // ResourceNotFound / Invalid project ID はすでに上でリターンされているはず。
        logToScreen(`2f. Full JSON retrieval/parsing failed. Trying meta-data API fallback. Error: ${e.message}`, true);
        status = STATUS_ERROR;
    }
    
    // 7. 上記の全てで作者名抽出に失敗した場合の最終フォールバック (SCRATCH_API_PROJECT_BASE)
    if (!authorUsername) {
        logToScreen('2g. Falling back to Scratch Meta Data API for author name.');
        try {
            const metaData = await $.ajax({
                url: SCRATCH_API_PROJECT_BASE + projectId,
                dataType: "json",
            });
            
            logJson('Scratch Meta Data API Response (Fallback)', metaData); // JSONログ追加

            if (metaData && metaData.author && metaData.author.username) {
                authorUsername = metaData.author.username;
                projectIdInJson = metaData.id || projectIdInJson;
                title = metaData.title || title;
                status = STATUS_SUCCESS;
            } else {
                // ここでも見つからない場合
                status = STATUS_NOT_FOUND; 
            }
        } catch(e) {
            logToScreen(`2g. Scratch Meta Data API fallback failed. Error: ${e.message}`, true);
            status = STATUS_ERROR;
        }
    }

    // データの組み立て（最終的に取得できた情報を使用）
    return {
        data: {
            author: authorUsername,
            id: projectIdInJson,
            title: title,
            visibility: 'visible', 
        },
        status: status
    };
}

/**
 * プロジェクトJSONからエージェント情報（device/browser）を取得する
 */
function analyzeProjectAgent(projectId) {
    logToScreen(`3. Analyzing Project Agent for ID: ${projectId}`);
    let deviceOutput = 'ResourceNotFound';
    let browserOutput = 'ResourceNotFound';
    
    // 1. トークンを取得
    return $.ajax({
        url: TURBOWARP_PROJECT_PROXY_BASE + projectId,
        dataType: "json",
    })
    // 2. トークンを使ってプロジェクトのJSON全体を取得
    .then(function (tokenData) {
        if (tokenData.error) {
            logToScreen(`3a. Project Token JSON Error (${tokenData.error}). Skipping Agent Analysis.`, true);
            return $.Deferred().reject('Token JSON Error').promise();
        }
        let token = tokenData["project_token"];
        return $.ajax({
            url: `https://projects.scratch.mit.edu/${projectId}/?token=${token}`,
            dataType: "text",
        });
    })
    // 3. エージェント文字列を抽出・解析
    .then(function (projectJson) {
        const agentRegex = /"agent"\s*:\s*"(.+?)"/s;
        const match = projectJson.match(agentRegex);
        
        if (match && match[1]) {
            const userAgent = match[1];
             if (/Windows NT 10.0/.test(userAgent)) { deviceOutput = 'Windows 10/11'; } 
            else if (/iPhone/.test(userAgent)) { deviceOutput = 'iPhone (iOS)'; } 
            else if (/iPad/.test(userAgent)) { deviceOutput = 'iPad (iPadOS)'; } 
            else if (/Mac OS X/.test(userAgent) && !/iPhone|iPad/.test(userAgent)) { deviceOutput = 'Mac (macOS)'; } 
            else if (/Android/.test(userAgent)) { deviceOutput = 'Android'; } 
            else if (/Linux/.test(userAgent)) { deviceOutput = 'Linux'; }
            
            if (/CriOS\/(\d+\.\d+)/.test(userAgent)) { browserOutput = 'Chrome for iOS (CriOS)'; } 
            else if (/Edg\/(\d+\.\d+)/.test(userAgent)) { browserOutput = 'Edge'; } 
            else if (/Chrome\/(\d+\.\d+)/.test(userAgent)) { browserOutput = 'Chrome'; } 
            else if (/Safari\/(\d+\.\d+)/.test(userAgent) && !/Chrome|CriOS/.test(userAgent)) { browserOutput = 'Safari'; } 
            else if (/Firefox\/(\d+\.\d+)/.test(userAgent)) { browserOutput = 'Firefox'; }
        }
        return { device: deviceOutput, browser: browserOutput };
    })
    .catch(function(error) {
        logToScreen(`3. Project Agent Analysis failed.`, true);
        return { device: 'ResourceNotFound', browser: 'ResourceNotFound' };
    });
}

// --- メイン処理フロー ---

/**
 * 全ての処理を統括する関数
 */
async function mainFlow() {
    const params = getQueryParameters();
    const ユザネ = params.username;
    const プロ番 = params.projectId;

    logToScreen(`[FLOW] Start processing (Version: ${VERSION}, User: ${ユザネ || 'N/A'}, Project: ${プロ番 || 'N/A'})`);

    // B. ユザネを受け取れたか
    if (!ユザネ) {
        // B. ユザネを受け取れていない
        if (!プロ番) {
            // B -> でない: プロ番を受け取れてない
            logToScreen('[FLOW] B -> Not Received: Both missing. Outputting error.');
            return displayResult({code:"ResourceNotFound", message:"'username' and 'projectId' do not exist."});
        } else {
            // B -> BA: プロ番を受け取れた
            logToScreen('[FLOW] B -> BA: Project ID received.');
            await BA_Flow(プロ番);
        }
    } else {
        // A. ユザネを受け取れた
        if (!プロ番) {
            // A -> AB: プロ番を受け取れてない
            logToScreen('[FLOW] A -> AB: Username received, Project ID missing.');
            await AB_Flow(ユザネ);
        } else {
            // A -> AA: プロ番を受け取れた
            logToScreen('[FLOW] A -> AA: Both received.');
            await AA_Flow(ユザネ, プロ番);
        }
    }
}

// --- フローAB ---
async function AB_Flow(ユザネ) {
    const userResult = await getUserData(ユザネ);

    if (userResult.status === STATUS_SUCCESS) {
        // データを受け取れた
        return displayResult({
            "username": userResult.data.username,
            "id": userResult.data.id,
            "joined": userResult.data.joined,
            "country": userResult.data.country,
            "images": userResult.data.images,
            "device": "ResourceNotFound",
            "browser": "ResourceNotFound",
            "message": "'projectId' do not exist."
        });
    } else if (userResult.status === STATUS_NOT_FOUND) {
        // {"error":"Resource does not exist"}と返ってきた
        return displayResult({
            "code":"ResourceNotFound", 
            "username": ユザネ, 
            "id": "ResourceNotFound",
            "joined": "ResourceNotFound",
            "country": "ResourceNotFound",
            "images": "ResourceNotFound",
            "device": "ResourceNotFound",
            "browser": "ResourceNotFound",
            "message":"'username' is not registered and 'projectId' do not exist."
        });
    } else if (userResult.status === STATUS_INVALID) {
        // {"error":"Invalid username"}と返ってきた
        return displayResult({
            "code":"Invalid username", 
            "username": ユザネ, 
            "id": "ResourceNotFound",
            "joined": "ResourceNotFound",
            "country": "ResourceNotFound",
            "images": "ResourceNotFound",
            "device": "ResourceNotFound",
            "browser": "ResourceNotFound",
            "message":"'username' is invalid and 'projectId' do not exist."
        });
    }
}

// --- フローBA ---
async function BA_Flow(プロ番) {
    const projectResult = await getProjectMetaData(プロ番);
    
    if (projectResult.status === STATUS_SUCCESS) {
        // データを受け取れた -> BA1へ
        await BA1_Flow(projectResult.data.author, projectResult.data.id, プロ番);
    } else if (projectResult.status === STATUS_NOT_FOUND || projectResult.status === STATUS_ERROR) {
        // {"error":"Resource does not exist"}と返ってきた または APIエラー
        return displayResult({
            "code":"ResourceNotFound",
            "message":"'username' do not exist and 'projectId' is not shared."
        });
    } else if (projectResult.status === STATUS_INVALID_PROJECT) {
        // {"error":"Invalid project ID"}と返ってきた
        return displayResult({
            "code":"Invalid project ID", 
            "message":"'username' do not exist and 'projectId' is invalid."
        });
    }
}

// --- フローBA1 ---
async function BA1_Flow(authorUsername, projectId, プロ番) {
    const agentData = await analyzeProjectAgent(プロ番);
    
    // authorUsernameがnullの場合は、ユーザーデータ取得をスキップ
    if (!authorUsername) {
         logToScreen('1. Fetching User Data for: null (Skipping real fetch due to null author)', true);
         return displayResult({
            "username": null, 
            "id": "ResourceNotFound",
            "joined": "ResourceNotFound",
            "country": "ResourceNotFound",
            "images": "ResourceNotFound",
            "device": agentData.device,
            "browser": agentData.browser,
            "message": "'username' is not registered." 
        });
    }

    const userResult = await getUserData(authorUsername); // プロジェクトidで回収したユザネ

    if (userResult.status === STATUS_SUCCESS) {
        // データを受け取れた
        return displayResult({
            "username": userResult.data.username,
            "id": userResult.data.id,
            "joined": userResult.data.joined,
            "country": userResult.data.country,
            "images": userResult.data.images,
            "device": agentData.device,
            "browser": agentData.browser,
            "message": "'username' do not exist."
        });
    } else if (userResult.status === STATUS_NOT_FOUND) {
        // {"error":"Resource does not exist"}と返ってきた (プロジェクト作者が存在しない稀なケース)
        return displayResult({
            "username": authorUsername, 
            "id": "ResourceNotFound",
            "joined": "ResourceNotFound",
            "country": "ResourceNotFound",
            "images": "ResourceNotFound",
            "device": agentData.device,
            "browser": agentData.browser,
            "message": "'username' is not registered."
        });
    } else if (userResult.status === STATUS_INVALID) {
        // {"error":"Invalid username"}と返ってきた (プロジェクト作者が無効な名前である稀なケース)
         return displayResult({
            "username": authorUsername, 
            "id": "ResourceNotFound",
            "joined": "ResourceNotFound",
            "country": "ResourceNotFound",
            "images": "ResourceNotFound",
            "device": agentData.device,
            "browser": agentData.browser,
            "message": "'username' is invalid."
        });
    }
}

// --- フローAA ---
async function AA_Flow(ユザネ, プロ番) {
    const userResult = await getUserData(ユザネ);
    let userState = STATUS_SUCCESS; // ユザネからの初期データ取得状態
    let userData = userResult.data || {};

    if (userResult.status === STATUS_NOT_FOUND) {
        userState = STATUS_NOT_REGISTERED; // アカウントがなかった
    } else if (userResult.status === STATUS_INVALID) {
        userState = STATUS_ACCOUNT_INVALID; // アカウントが無効だった
    } else if (userResult.status === STATUS_ERROR) {
        // API通信エラーは、入力されたユザネが無効/不在の場合に起きるため、ここでは Invalid として処理を継続
        userState = STATUS_ACCOUNT_INVALID; 
    }
    
    // AA1へ: この時にJSON回収、読み取り (device, browserを記録)
    const agentData = await analyzeProjectAgent(プロ番);
    const projectResult = await getProjectMetaData(プロ番);
    let projectData = projectResult.data || {};

    if (projectResult.status === STATUS_SUCCESS) {
        // データを受け取れた -> AA1Aへ
        await AA1A_Flow(ユザネ, userData, userState, agentData, projectData);
    } else if (projectResult.status === STATUS_NOT_FOUND) {
        // {"error":"Resource does not exist"}と返ってきた -> AA1Bへ
        await AA1B_Flow(ユザネ, userState, userData, agentData);
    } else if (projectResult.status === STATUS_INVALID_PROJECT || projectResult.status === STATUS_ERROR) {
        // {"error":"Invalid project ID"}と返ってきた OR API通信エラー-> AA1Cへ
        await AA1C_Flow(ユザネ, userState, userData, agentData);
    }
}

// --- フローAA1A ---
async function AA1A_Flow(ユザネ, userData, userState, agentData, projectData) {
    // プロジェクト作者の完全なユーザー情報を取得
    let projectAuthorData = {};
    // projectData.authorがnullの場合は、getUserDataを呼ばないようガード
    if (projectData.author) {
        const authorResult = await getUserData(projectData.author);
        projectAuthorData = authorResult.data || {};
    }
    
    // 入手したusername,id,imagesと持っていたそのデータが合致したか
    const isMatched = (userState === STATUS_SUCCESS && 
                      userData.username === projectData.author);
    
    if (userState === STATUS_SUCCESS) {
        // ユザネから正しく受け取れた
        if (isMatched) {
            // 合致した
            return displayResult({
                "username": userData.username,
                "id": userData.id,
                "joined": userData.joined,
                "country": userData.country,
                "images": userData.images,
                "device": agentData.device,
                "browser": agentData.browser
            });
        } else {
            // 合致しなかった
            return displayResult({
                "code": "Not correspond",
                "message": "'username' and 'projectId' do not correspond."
            });
        }
    } else if (userState === STATUS_NOT_REGISTERED) {
        // アカウントがなかった記録があった (プロジェクト作者のデータで埋める)
        return displayResult({
            "username": projectData.author,
            "id": projectAuthorData.id || "ResourceNotFound",
            "joined": projectAuthorData.joined || "ResourceNotFound",
            "country": projectAuthorData.country || "ResourceNotFound",
            "images": projectAuthorData.images || "ResourceNotFound",
            "device": agentData.device,
            "browser": agentData.browser,
            "message": `'input username' (${ユザネ}) is not registered.` // メッセージを明確化
        });
    } else if (userState === STATUS_ACCOUNT_INVALID) {
        // アカウントが無効という記録があった (プロジェクト作者のデータで埋める)
        return displayResult({
            "username": projectData.author,
            "id": projectAuthorData.id || "ResourceNotFound",
            "joined": projectAuthorData.joined || "ResourceNotFound",
            "country": projectAuthorData.country || "ResourceNotFound",
            "images": projectAuthorData.images || "ResourceNotFound",
            "device": agentData.device,
            "browser": agentData.browser,
            "message": `'input username' (${ユザネ}) is invalid.` // メッセージを明確化
        });
    }
}

// --- フローAA1B ---
async function AA1B_Flow(ユザネ, userState, userData, agentData) {
    // プロジェクトIDが見つからない/APIエラーのルート ('projectId' is not shared.)
    
    if (userState === STATUS_SUCCESS) {
        // ユザネから正しく受け取れた
        return displayResult({
            "username": userData.username,
            "id": userData.id,
            "joined": userData.joined,
            "country": userData.country,
            "images": userData.images,
            "device": "ResourceNotFound",
            "browser": "ResourceNotFound",
            "message": "'projectId' is not shared."
        });
    } else if (userState === STATUS_NOT_REGISTERED) {
        // アカウントが見つからなかった
        return displayResult({
            "code": "ResourceNotFound",
            "username": ユザネ,
            "id": "ResourceNotFound",
            "joined": "ResourceNotFound",
            "country": "ResourceNotFound",
            "images": "ResourceNotFound",
            "device": "ResourceNotFound",
            "browser": "ResourceNotFound",
            "message": `'input username' (${ユザネ}) is not registered and 'projectId' is not shared.` // メッセージを明確化
        });
    } else if (userState === STATUS_ACCOUNT_INVALID) {
        // アカウントが無効だった
        return displayResult({
            "code": "Invalid username",
            "username": ユザネ,
            "id": "ResourceNotFound",
            "joined": "ResourceNotFound",
            "country": "ResourceNotFound",
            "images": "ResourceNotFound",
            "device": "ResourceNotFound",
            "browser": "ResourceNotFound",
            "message": `'input username' (${ユザネ}) is invalid and 'projectId' is not shared.` // メッセージを明確化
        });
    }
}

// --- フローAA1C ---
async function AA1C_Flow(ユザネ, userState, userData, agentData) {
    // プロジェクトIDが無効 (Invalid project ID) のルート
    
    if (userState === STATUS_SUCCESS) {
        // ユザネから正しく受け取れた
        return displayResult({
            "username": userData.username,
            "id": userData.id,
            "joined": userData.joined,
            "country": userData.country,
            "images": userData.images,
            "device": "ResourceNotFound",
            "browser": "ResourceNotFound",
            "message": "'projectId' is invalid."
        });
    } else if (userState === STATUS_NOT_REGISTERED) {
        // アカウントが見つからなかった
        return displayResult({
            "code": "ResourceNotFound",
            "username": ユザネ,
            "id": "ResourceNotFound",
            "joined": "ResourceNotFound",
            "country": "ResourceNotFound",
            "images": "ResourceNotFound",
            "device": "ResourceNotFound",
            "browser": "ResourceNotFound",
            "message": `'input username' (${ユザネ}) is not registered and 'projectId' is invalid.` // メッセージを明確化
        });
    } else if (userState === STATUS_ACCOUNT_INVALID) {
        // アカウントが無効だった
        return displayResult({
            "code": "Invalid username",
            "username": ユザネ,
            "id": "ResourceNotFound",
            "joined": "ResourceNotFound",
            "country": "ResourceNotFound",
            "images": "ResourceNotFound",
            "device": "ResourceNotFound",
            "browser": "ResourceNotFound",
            "message": `'input username' (${ユザネ}) is invalid and 'projectId' is invalid.` // メッセージを明確化
        });
    }
}


// --- 実行ロジック ---
$(document).ready(function() {
    document.title = window.location.hostname;
    
    // すぐにメインフローを呼び出す
    mainFlow();
});
  </script>
</body>
</html>
