<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title></title> 
  
  <style>
    body {
      margin: 0;
      font-family: "Helvetica Neue", "Helvetica", Arial, sans-serif;
      color: #000;
      line-height: 1.5em;
      font-size: 16px;
      background-color: white; 
    }

    #container {
      width: auto;
      margin: 0;
      padding: 10px;
    }

    #result-output {
      /* 結果が出るまで完全に非表示 */
      white-space: pre-wrap;
      padding: 0;
      border: none;
      background-color: transparent;
      color: #000;
      display: none; 
      font-family: monospace; 
    }
    
    /* デバッグログ専用のスタイル */
    #debug-log {
      margin-top: 20px;
      padding-top: 10px;
      border-top: 1px solid #ccc;
      white-space: pre-wrap;
      font-size: 14px;
      color: #777;
    }
    .error-log {
      color: red;
      font-weight: bold;
    }
    
    #profile-image { display: none; }
  </style>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>
<body>
  <div id="container">
    <p id="result-output"></p> 
    <p id="debug-log"></p> 
  </div>

  <script>
"use strict";

const TURBOWARP_USER_PROXY_BASE = 'https://trampoline.turbowarp.org/proxy/users/';
const TURBOWARP_PROJECT_PROXY_BASE = 'https://trampoline.turbowarp.org/proxy/projects/';
const $output = $('#result-output');
const $debugLog = $('#debug-log');

// --- 定数/ステータス ---
const STATUS_SUCCESS = 'Success';
const STATUS_NOT_FOUND = 'Resource does not exist';
const STATUS_INVALID = 'Invalid username'; 
const STATUS_INVALID_PROJECT = 'Invalid project ID';
const STATUS_ERROR = 'Error';
const STATUS_NO_INPUT = 'No input';
const STATUS_NOT_REGISTERED = 'Account not registered'; // 内部でのみ使用
const STATUS_ACCOUNT_INVALID = 'Account invalid'; // 内部でのみ使用

// --- ヘルパー関数 ---

function logToScreen(message, isError = false) {
    const className = isError ? 'error-log' : '';
    $debugLog.append(`<span class="${className}">[${new Date().toLocaleTimeString()}] ${message}</span><br>`);
}

/**
 * URLクエリパラメータから username と projectId を取得する
 */
function getQueryParameters() {
    const urlParams = new URLSearchParams(window.location.search);
    return {
        username: urlParams.get('username') ? urlParams.get('username').trim() : null,
        projectId: urlParams.get('projectId') ? urlParams.get('projectId').trim() : null
    };
}

/**
 * JSONライクな文字列出力
 */
function jsonToScratchString(obj) {
    let parts = [];
    for (const key in obj) {
        if (!obj.hasOwnProperty(key)) continue;
        const value = typeof obj[key] === 'string' 
            ? `"${obj[key].replace(/\\/g, '\\\\').replace(/"/g, '\\"')}"` 
            : obj[key];
        
        parts.push(`"${key}":${value}`);
    }
    return `{${parts.join(',')}}`;
}

/**
 * 結果を出力エリアに表示する
 */
function displayResult(result) {
    logToScreen('[DEBUG] Attempting to display result.'); 
    if (typeof result === 'string') {
        $output.text(result);
    } else {
        // FATAL JSON ERROR回避のためtry-catchを追加
        try {
            $output.html(jsonToScratchString(result));
        } catch (e) {
            logToScreen('FATAL ERROR: Could not format/display JSON. ' + e.message, true);
            $output.text('FATAL JSON ERROR');
        }
    }
    $output.css('display', 'block');
    logToScreen('[END] Output successful.');
}

/**
 * ユーザーAPIからデータを取得する
 */
function getUserData(username) {
    logToScreen(`1. Fetching User Data for: ${username}`);
    return $.ajax({
        url: TURBOWARP_USER_PROXY_BASE + username,
        dataType: 'json',
    })
    .then(function(userData) {
        if (userData.error === 'Resource does not exist' || userData.error === 'NotFound') {
            return { status: STATUS_NOT_FOUND, data: null };
        }
        if (userData.error === 'Invalid username') {
            return { status: STATUS_INVALID, data: null };
        }
        return { 
            status: STATUS_SUCCESS, 
            data: {
                username: userData.username,
                id: userData.id,
                joined: userData.history.joined ? new Date(userData.history.joined).toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-') : '',
                country: userData.profile.country || '',
                images: userData.profile.images['90x90'] ? userData.profile.images['90x90'].split('?')[0] : '',
            }
        };
    })
    .catch(function(reason) {
        logToScreen(`1. User API failed for ${username}`, true);
        return { status: STATUS_ERROR, data: null };
    });
}

/**
 * プロジェクトJSONからメタデータを取得する (プロジェクトJSONを解析する方式)
 */
function getProjectMetaData(projectId) {
    logToScreen(`2. Fetching Project Meta Data for ID: ${projectId} (via Full JSON Proxy)`);
    
    // 1. プロジェクトのトークンを取得
    return $.ajax({
        url: TURBOWARP_PROJECT_PROXY_BASE + projectId,
        dataType: "json",
    })
    // 2. トークンを使ってプロジェクトのJSON全体を取得
    .then(function (tokenData) {
        if (tokenData.error) {
            // トークン取得に失敗 = プロジェクトが存在しないか無効
            if (tokenData.error === 'Resource does not exist' || tokenData.error === 'NotFound') {
                return $.Deferred().reject(STATUS_NOT_FOUND).promise();
            }
            if (tokenData.error === 'Invalid project ID') {
                return $.Deferred().reject(STATUS_INVALID_PROJECT).promise();
            }
            return $.Deferred().reject(STATUS_ERROR).promise();
        }
        let token = tokenData["project_token"];
        
        // Scratch公式からJSON全体を取得
        return $.ajax({
            url: `https://projects.scratch.mit.edu/${projectId}/?token=${token}`,
            dataType: "text",
        });
    })
    // 3. 取得したテキストから作者名などのメタデータを抽出
    .then(function (projectJsonText) {
        // author内のusernameを直接正規表現で抽出
        const authorUsernameRegex = /"author"\s*:\s*\{[^}]*?"username"\s*:\s*"(.+?)"/s;
        const idRegex = /"id"\s*:\s*(\d+)/;
        const titleRegex = /"title"\s*:\s*"(.+?)"/s;
        
        const authorMatch = projectJsonText.match(authorUsernameRegex);
        const idMatch = projectJsonText.match(idRegex);
        const titleMatch = projectJsonText.match(titleRegex);

        // 正規表現にマッチしたグループ1（ユザネ文字列）を取得
        let authorUsername = authorMatch ? authorMatch[1] : null; 
        let projectIdInJson = idMatch ? idMatch[1] : null;
        
        // データの組み立て
        return {
            data: {
                author: authorUsername,
                id: projectIdInJson,
                title: titleMatch ? titleMatch[1] : null,
                visibility: 'visible',
            },
            status: STATUS_SUCCESS
        };
    })
    .catch(function(reason) {
        if (reason === STATUS_NOT_FOUND) {
            return { status: STATUS_NOT_FOUND, data: null };
        }
        if (reason === STATUS_INVALID_PROJECT) {
            return { status: STATUS_INVALID_PROJECT, data: null };
        }
        logToScreen(`2. Project Meta Data API (JSON Parsing) failed for ${projectId}`, true);
        return { status: STATUS_ERROR, data: null }; 
    });
}

/**
 * プロジェクトJSONからエージェント情報（device/browser）を取得する
 */
function analyzeProjectAgent(projectId) {
    logToScreen(`3. Analyzing Project Agent for ID: ${projectId}`);
    let deviceOutput = 'ResourceNotFound';
    let browserOutput = 'ResourceNotFound';
    
    // 1. トークンを取得
    return $.ajax({
        url: TURBOWARP_PROJECT_PROXY_BASE + projectId,
        dataType: "json",
    })
    // 2. トークンを使ってプロジェクトのJSON全体を取得
    .then(function (tokenData) {
        if (tokenData.error) {
            logToScreen('3a. Project Token JSON Error. Skipping Agent Analysis.', true);
            return $.Deferred().reject('Token JSON Error').promise();
        }
        let token = tokenData["project_token"];
        return $.ajax({
            url: `https://projects.scratch.mit.edu/${projectId}/?token=${token}`,
            dataType: "text",
        });
    })
    // 3. エージェント文字列を抽出・解析
    .then(function (projectJson) {
        const agentRegex = /"agent"\s*:\s*"(.+?)"/s;
        const match = projectJson.match(agentRegex);
        
        if (match && match[1]) {
            const userAgent = match[1];
             if (/Windows NT 10.0/.test(userAgent)) { deviceOutput = 'Windows 10/11'; } 
            else if (/iPhone/.test(userAgent)) { deviceOutput = 'iPhone (iOS)'; } 
            else if (/iPad/.test(userAgent)) { deviceOutput = 'iPad (iPadOS)'; } 
            else if (/Mac OS X/.test(userAgent) && !/iPhone|iPad/.test(userAgent)) { deviceOutput = 'Mac (macOS)'; } 
            else if (/Android/.test(userAgent)) { deviceOutput = 'Android'; } 
            else if (/Linux/.test(userAgent)) { deviceOutput = 'Linux'; }
            
            if (/CriOS\/(\d+\.\d+)/.test(userAgent)) { browserOutput = 'Chrome for iOS (CriOS)'; } 
            else if (/Edg\/(\d+\.\d+)/.test(userAgent)) { browserOutput = 'Edge'; } 
            else if (/Chrome\/(\d+\.\d+)/.test(userAgent)) { browserOutput = 'Chrome'; } 
            else if (/Safari\/(\d+\.\d+)/.test(userAgent) && !/Chrome|CriOS/.test(userAgent)) { browserOutput = 'Safari'; } 
            else if (/Firefox\/(\d+\.\d+)/.test(userAgent)) { browserOutput = 'Firefox'; }
        }
        return { device: deviceOutput, browser: browserOutput };
    })
    .catch(function(error) {
        logToScreen(`3. Project Agent Analysis failed.`, true);
        return { device: 'ResourceNotFound', browser: 'ResourceNotFound' };
    });
}

// --- メイン処理フロー ---

/**
 * 全ての処理を統括する関数
 */
async function mainFlow() {
    const params = getQueryParameters();
    const ユザネ = params.username;
    const プロ番 = params.projectId;

    logToScreen(`[FLOW] Start processing (User: ${ユザネ || 'N/A'}, Project: ${プロ番 || 'N/A'})`);

    // B. ユザネを受け取れたか
    if (!ユザネ) {
        // B. ユザネを受け取れていない
        if (!プロ番) {
            // B -> でない: プロ番を受け取れてない
            logToScreen('[FLOW] B -> Not Received: Both missing. Outputting error.');
            return displayResult({code:"ResourceNotFound", message:"'username' and 'projectId' do not exist."});
        } else {
            // B -> BA: プロ番を受け取れた
            logToScreen('[FLOW] B -> BA: Project ID received.');
            await BA_Flow(プロ番);
        }
    } else {
        // A. ユザネを受け取れた
        if (!プロ番) {
            // A -> AB: プロ番を受け取れてない
            logToScreen('[FLOW] A -> AB: Username received, Project ID missing.');
            await AB_Flow(ユザネ);
        } else {
            // A -> AA: プロ番を受け取れた
            logToScreen('[FLOW] A -> AA: Both received.');
            await AA_Flow(ユザネ, プロ番);
        }
    }
}

// --- フローAB ---
async function AB_Flow(ユザネ) {
    const userResult = await getUserData(ユザネ);

    if (userResult.status === STATUS_SUCCESS) {
        // データを受け取れた
        return displayResult({
            "username": userResult.data.username,
            "id": userResult.data.id,
            "joined": userResult.data.joined,
            "country": userResult.data.country,
            "images": userResult.data.images,
            "device": "ResourceNotFound",
            "browser": "ResourceNotFound",
            "message": "'projectId' do not exist."
        });
    } else if (userResult.status === STATUS_NOT_FOUND || userResult.status === STATUS_ERROR) {
        // {"error":"Resource does not exist"}と返ってきた
        return displayResult({
            "code":"ResourceNotFound", 
            "username": ユザネ, // 未登録の場合、入力されたユザネを返す
            "id": "ResourceNotFound",
            "joined": "ResourceNotFound",
            "country": "ResourceNotFound",
            "images": "ResourceNotFound",
            "device": "ResourceNotFound",
            "browser": "ResourceNotFound",
            "message":"'username' is not registered and 'projectId' do not exist."
        });
    } else if (userResult.status === STATUS_INVALID) {
        // {"error":"Invalid username"}と返ってきた
        return displayResult({
            "code":"Invalid username", 
            "username": ユザネ, // 無効な場合、入力されたユザネを返す
            "id": "ResourceNotFound",
            "joined": "ResourceNotFound",
            "country": "ResourceNotFound",
            "images": "ResourceNotFound",
            "device": "ResourceNotFound",
            "browser": "ResourceNotFound",
            "message":"'username' is invalid and 'projectId' do not exist."
        });
    }
}

// --- フローBA ---
async function BA_Flow(プロ番) {
    const projectResult = await getProjectMetaData(プロ番);
    
    if (projectResult.status === STATUS_SUCCESS) {
        // データを受け取れた -> BA1へ
        await BA1_Flow(projectResult.data.author, projectResult.data.id, プロ番);
    } else if (projectResult.status === STATUS_NOT_FOUND || projectResult.status === STATUS_ERROR) {
        // {"error":"Resource does not exist"}と返ってきた または APIエラー
        return displayResult({
            "code":"ResourceNotFound",
            "message":"'username' do not exist and 'projectId' is not shared."
        });
    } else if (projectResult.status === STATUS_INVALID_PROJECT) {
        // {"error":"Invalid project ID"}と返ってきた
        return displayResult({
            "code":"Invalid project ID", 
            "message":"'username' do not exist and 'projectId' is invalid."
        });
    }
}

// --- フローBA1 ---
async function BA1_Flow(authorUsername, projectId, プロ番) {
    const agentData = await analyzeProjectAgent(プロ番);
    const userResult = await getUserData(authorUsername); // プロジェクトidで回収したユザネ

    if (userResult.status === STATUS_SUCCESS) {
        // データを受け取れた
        return displayResult({
            "username": userResult.data.username,
            "id": userResult.data.id,
            "joined": userResult.data.joined,
            "country": userResult.data.country,
            "images": userResult.data.images,
            "device": agentData.device,
            "browser": agentData.browser,
            "message": "'username' do not exist."
        });
    } else if (userResult.status === STATUS_NOT_FOUND || userResult.status === STATUS_INVALID || userResult.status === STATUS_ERROR) {
        // {"error":"Resource does not exist"}と返ってきた / Invalid username/ErrorもNotFoundとして処理
        return displayResult({
            "username": authorUsername, // プロジェクト作者名 (unnot-leasなど)
            "id": "ResourceNotFound",
            "joined": "ResourceNotFound",
            "country": "ResourceNotFound",
            "images": "ResourceNotFound",
            "device": agentData.device,
            "browser": agentData.browser,
            "message": "'username' is not registered."
        });
    } 
}

// --- フローAA ---
async function AA_Flow(ユザネ, プロ番) {
    const userResult = await getUserData(ユザネ);
    let userState = STATUS_SUCCESS; // ユザネからの初期データ取得状態
    let userData = userResult.data || {};

    if (userResult.status === STATUS_NOT_FOUND || userResult.status === STATUS_ERROR) {
        userState = STATUS_NOT_REGISTERED; // アカウントがなかった/エラー
    } else if (userResult.status === STATUS_INVALID) {
        userState = STATUS_ACCOUNT_INVALID; // アカウントが無効だった
    }
    
    // AA1へ: この時にJSON回収、読み取り (device, browserを記録)
    const agentData = await analyzeProjectAgent(プロ番);
    const projectResult = await getProjectMetaData(プロ番);
    let projectData = projectResult.data || {};

    if (projectResult.status === STATUS_SUCCESS) {
        // データを受け取れた -> AA1Aへ
        await AA1A_Flow(ユザネ, userData, userState, agentData, projectData);
    } else if (projectResult.status === STATUS_NOT_FOUND || projectResult.status === STATUS_ERROR) { // ★修正: APIエラーは非共有（AA1B）として処理
        // {"error":"Resource does not exist"}と返ってきた OR APIエラー -> AA1Bへ
        await AA1B_Flow(ユザネ, userState, userData, agentData);
    } else if (projectResult.status === STATUS_INVALID_PROJECT) {
        // {"error":"Invalid project ID"}と返ってきた -> AA1Cへ
        await AA1C_Flow(ユザネ, userState, userData, agentData);
    }
}

// --- フローAA1A ---
async function AA1A_Flow(ユザネ, userData, userState, agentData, projectData) {
    // プロジェクト作者の完全なユーザー情報を取得
    let projectAuthorData = {};
    // projectData.authorがnullの場合にgetUserDataを呼ばないようガード
    if (projectData.author) {
        const authorResult = await getUserData(projectData.author);
        projectAuthorData = authorResult.data || {};
    }
    
    // 入手したusername,id,imagesと持っていたそのデータが合致したか
    const isMatched = (userState === STATUS_SUCCESS && 
                      userData.username === projectData.author && 
                      userData.id === projectAuthorData.id);

    if (userState === STATUS_SUCCESS) {
        // ユザネから正しく受け取れた
        if (isMatched) {
            // 合致した
            return displayResult({
                "username": userData.username,
                "id": userData.id,
                "joined": userData.joined,
                "country": userData.country,
                "images": userData.images,
                "device": agentData.device,
                "browser": agentData.browser
            });
        } else {
            // 合致しなかった
            return displayResult({
                "code": "Not correspond",
                "message": "'username' and 'projectId' do not correspond."
            });
        }
    } else if (userState === STATUS_NOT_REGISTERED) {
        // アカウントがなかった記録があった (プロジェクト作者のデータで埋める)
        return displayResult({
            "username": projectData.author,
            "id": projectAuthorData.id || "ResourceNotFound",
            "joined": projectAuthorData.joined || "ResourceNotFound",
            "country": projectAuthorData.country || "ResourceNotFound",
            "images": projectAuthorData.images || "ResourceNotFound",
            "device": agentData.device,
            "browser": agentData.browser,
            "message": "'username' is not registered."
        });
    } else if (userState === STATUS_ACCOUNT_INVALID) {
        // アカウントが無効という記録があった (プロジェクト作者のデータで埋める)
        return displayResult({
            "username": projectData.author,
            "id": projectAuthorData.id || "ResourceNotFound",
            "joined": projectAuthorData.joined || "ResourceNotFound",
            "country": projectAuthorData.country || "ResourceNotFound",
            "images": projectAuthorData.images || "ResourceNotFound",
            "device": agentData.device,
            "browser": agentData.browser,
            "message": "'username' is invalid."
        });
    }
}

// --- フローAA1B ---
async function AA1B_Flow(ユザネ, userState, userData, agentData) {
    if (userState === STATUS_SUCCESS) {
        // ユザネから正しく受け取れた
        return displayResult({
            "username": userData.username,
            "id": userData.id,
            "joined": userData.joined,
            "country": userData.country,
            "images": userData.images,
            "device": "ResourceNotFound",
            "browser": "ResourceNotFound",
            "message": "'projectId' is not shared."
        });
    } else if (userState === STATUS_NOT_REGISTERED || userState === STATUS_ACCOUNT_INVALID) { // ★修正: Invalidもユザネで埋める
        // アカウントがなかった/無効という記録があった
        return displayResult({
            "code": userState === STATUS_NOT_REGISTERED ? "ResourceNotFound" : "Invalid username",
            "username": ユザネ, // ★修正: クエリで入力されたユザネを返す
            "id": "ResourceNotFound",
            "joined": "ResourceNotFound",
            "country": "ResourceNotFound",
            "images": "ResourceNotFound",
            "device": "ResourceNotFound",
            "browser": "ResourceNotFound",
            "message": userState === STATUS_NOT_REGISTERED ? "'username' is not registered and 'projectId' is not shared." : "'username' is invalid."
        });
    }
}

// --- フローAA1C ---
async function AA1C_Flow(ユザネ, userState, userData, agentData) {
    if (userState === STATUS_SUCCESS) {
        // ユザネから正しく受け取れた
        return displayResult({
            "username": userData.username,
            "id": userData.id,
            "joined": userData.joined,
            "country": userData.country,
            "images": userData.images,
            "device": "ResourceNotFound",
            "browser": "ResourceNotFound",
            "message": "'projectId' is invalid."
        });
    } else if (userState === STATUS_NOT_REGISTERED || userState === STATUS_ACCOUNT_INVALID) { // ★修正: Invalidもユザネで埋める
        // アカウントがなかった/無効という記録があった
         return displayResult({
            "code": userState === STATUS_NOT_REGISTERED ? "ResourceNotFound" : "Invalid username",
            "username": ユザネ, // ★修正: クエリで入力されたユザネを返す
            "id": "ResourceNotFound",
            "joined": "ResourceNotFound",
            "country": "ResourceNotFound",
            "images": "ResourceNotFound",
            "device": "ResourceNotFound",
            "browser": "ResourceNotFound",
            "message": userState === STATUS_NOT_REGISTERED ? "'username' is not registered and 'projectId' is invalid." : "'username' is invalid."
        });
    }
}


// --- 実行ロジック ---
$(document).ready(function() {
    document.title = window.location.hostname;
    
    // すぐにメインフローを呼び出す
    mainFlow();
});
  </script>
</body>
</html>
