<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title></title> 
  
  <style>
    body {
      margin: 0;
      font-family: "Helvetica Neue", "Helvetica", Arial, sans-serif;
      color: #000;
      line-height: 1.5em;
      font-size: 16px;
      background-color: white; 
    }

    #container {
      width: auto;
      margin: 0;
      padding: 10px;
    }

    #result-output {
      /* 結果が出るまで完全に非表示 */
      white-space: pre-wrap;
      padding: 0;
      border: none;
      background-color: transparent;
      color: #000;
      display: none; 
    }
    
    /* デバッグログ専用のスタイル */
    #debug-log {
      margin-top: 20px;
      padding-top: 10px;
      border-top: 1px solid #ccc;
      white-space: pre-wrap;
      font-size: 14px;
      color: #777;
    }
    .error-log {
      color: red;
      font-weight: bold;
    }
    
    #profile-image { display: none; }
  </style>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>
<body>
  <div id="container">
    <p id="result-output"></p> 
    <p id="debug-log"></p> 
  </div>

  <script>
"use strict";

const TURBOWARP_USER_PROXY_BASE = 'https://trampoline.turbowarp.org/proxy/users/';
const TURBOWARP_PROJECT_PROXY_BASE = 'https://trampoline.turbowarp.org/proxy/projects/';
const $output = $('#result-output');
const $debugLog = $('#debug-log');

// --- ヘルパー関数 ---

function logToScreen(message, isError = false) {
    const className = isError ? 'error-log' : '';
    $debugLog.append(`<span class="${className}">[${new Date().toLocaleTimeString()}] ${message}</span><br>`);
}

/**
 * URLクエリパラメータから user と projectId を取得する
 */
function getQueryParameters() {
    const urlParams = new URLSearchParams(window.location.search);
    return {
        username: urlParams.get('user') ? urlParams.get('user').trim() : null,
        projectId: urlParams.get('projectId') ? urlParams.get('projectId').trim() : null
    };
}

/**
 * ユーザー情報とプロジェクト情報を組み合わせて出力するヘルパー関数
 */
function renderOutput(userData, projectData, agentData) {
    let outputText = '';
    
    // ----------------- ユーザー情報 -----------------
    if (userData && userData.username) {
        const userName = userData.username || '-';
        const userId = userData.id || '-';
        const joinedDate = userData.history.joined ? new Date(userData.history.joined).toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-') : '-';
        const country = userData.profile.country || '-';
        
        const rawImageUrl = userData.profile.images['90x90'] || '';
        const imageUrl = rawImageUrl.split('?')[0]; 
        
        outputText += `username: ${userName}<br>`;
        outputText += `id: ${userId}<br>`;
        outputText += `joined: ${joinedDate}<br>`;
        outputText += `country: ${country}<br>`;
        outputText += `images: ${imageUrl}<br>`; 
        
        outputText += `Unread count: -<br>`;
        
        const finalDevice = agentData.device || '-';
        const finalBrowser = agentData.browser || '-';
        outputText += `device: ${finalDevice}<br>`; 
        outputText += `browser: ${finalBrowser}<br>`; 
    } else if (projectData && projectData.author) {
        // userクエリがなく、プロジェクトの作者名で補完できた場合
        outputText += `author (from project): ${projectData.author}<br>`;
        outputText += `device: ${agentData.device || '-'}<br>`; 
        outputText += `browser: ${agentData.browser || '-'}<br>`; 
    }

    // ----------------- プロジェクト情報 -----------------
    if (projectData && projectData.id) {
        if (outputText.length > 0) {
            outputText += '<br>--- Project Info ---<br>';
        }
        outputText += `project_id: ${projectData.id}<br>`;
        outputText += `title: ${projectData.title || '-'}<br>`;
        outputText += `visibility: ${projectData.visibility || '-'}<br>`;
        outputText += `author: ${projectData.author || '-'}<br>`;
    }
    
    if (outputText.length === 0) {
        // クエリはあったが、両方のAPIでエラー（NotFound/Invalidなど）の場合
        $output.text('NotFound'); 
        $output.css('display', 'block');
        logToScreen('[END] Output: NotFound (No data successfully fetched).');
    } else {
        // 結果が出た時
        $output.html(outputText);
        $output.css('display', 'block');
        logToScreen('[END] Output successful.');
    }
}

/**
 * プロジェクトIDからデバイス/ブラウザ情報を取得する
 */
function analyzeProjectAgent(projectId) {
    logToScreen(`4. Start Project Agent Analysis for ID: ${projectId}`);
    let deviceOutput = '';
    let browserOutput = '';
    
    return $.ajax({
        url: TURBOWARP_PROJECT_PROXY_BASE + projectId,
        dataType: "json",
    })
    .then(function (tokenData) {
        if (tokenData.error) {
            logToScreen('4a. Project Token JSON Error. Skipping Agent Analysis.', true);
            return $.Deferred().reject('Token JSON Error').promise();
        }

        logToScreen('4a. Project Token fetched.');
        let token = tokenData["project_token"];
        
        return $.ajax({
            url: `https://projects.scratch.mit.edu/${projectId}/?token=${token}`,
            dataType: "text",
        });
    })
    .then(function (projectJson) {
        logToScreen('4b. Project JSON fetched. Analyzing User-Agent.');
        const agentRegex = /"agent"\s*:\s*"(.+?)"/s;
        const match = projectJson.match(agentRegex);
        
        if (match && match[1]) {
            const userAgent = match[1];
            
             if (/Windows NT 10.0/.test(userAgent)) { deviceOutput = 'Windows 10/11'; } 
            else if (/iPhone/.test(userAgent)) { deviceOutput = 'iPhone (iOS)'; } 
            else if (/iPad/.test(userAgent)) { deviceOutput = 'iPad (iPadOS)'; } 
            else if (/Mac OS X/.test(userAgent) && !/iPhone|iPad/.test(userAgent)) { deviceOutput = 'Mac (macOS)'; } 
            else if (/Android/.test(userAgent)) { deviceOutput = 'Android'; } 
            else if (/Linux/.test(userAgent)) { deviceOutput = 'Linux'; }
            
            if (/CriOS\/(\d+\.\d+)/.test(userAgent)) { browserOutput = 'Chrome for iOS (CriOS)'; } 
            else if (/Edg\/(\d+\.\d+)/.test(userAgent)) { browserOutput = 'Edge'; } 
            else if (/Chrome\/(\d+\.\d+)/.test(userAgent)) { browserOutput = 'Chrome'; } 
            else if (/Safari\/(\d+\.\d+)/.test(userAgent) && !/Chrome|CriOS/.test(userAgent)) { browserOutput = 'Safari'; } 
            else if (/Firefox\/(\d+\.\d+)/.test(userAgent)) { browserOutput = 'Firefox'; }
        }
        return { device: deviceOutput, browser: browserOutput };
    })
    .catch(function(error) {
        logToScreen(`4. Project Agent Analysis failed. Error Status: ${error.statusText || 'Unknown'}`, true);
        return { device: '', browser: '' }; 
    });
}

/**
 * プロジェクトIDからメタデータを取得する (作者名を含む)
 */
function getProjectMetaData(projectId) {
    logToScreen(`2. Start Project Meta Data fetch for ID: ${projectId}`);
    return $.ajax({
        url: `https://api.scratch.mit.edu/projects/${projectId}`, 
        dataType: 'json',
    })
    .then(function(response) {
        logToScreen('2a. Project Meta Data API success.');
        
        if (response.error === 'Resource does not exist' || response.error === 'Invalid project ID') {
             logToScreen('2b. Project JSON Error Detected: Not Found or Invalid.', true);
             return {};
        }
        
        return {
            id: response.id,
            title: response.title,
            visibility: response.visibility,
            author: response.author ? response.author.username : null
        };
    })
    .catch(function(error) {
        logToScreen(`2. Project Meta Data API failed. Status: ${error.status || 'N/A'}, StatusText: ${error.statusText || 'Unknown'}`, true);
        return {}; 
    });
}

/**
 * ユーザーIDからユーザー情報を取得する
 */
function getUserData(username) {
    logToScreen(`1. Start User Data fetch for user: ${username}`);
    return $.ajax({
        url: TURBOWARP_USER_PROXY_BASE + username,
        dataType: 'json',
    })
    .then(function(userData) {
        logToScreen('1a. User Data API success.');
        
        if (userData.error === 'Resource does not exist' || userData.error === 'Invalid username') {
            logToScreen('1b. JSON Error Detected: Invalid username or Not Found.', true);
            return null;
        }
        return userData;
    })
    .catch(function(reason) {
        const status = reason && reason.status ? reason.status : 'N/A';
        
        if (status === 404 || status === 400) {
            logToScreen(`1c. HTTP Error Detected: ${status} Not Found/Invalid.`, true);
            return null;
        }
        
        logToScreen(`1d. Unhandled User API Error. Status: ${status}.`, true);
        return $.Deferred().reject('User API Fatal Error').promise();
    });
}


/**
 * メインのデータ取得ロジック
 */
function loadAndAnalyzeData(username, projectId) {
    logToScreen(`[START] Analyzing Data (User: ${username || 'N/A'}, Project: ${projectId || 'N/A'})`);
    
    let userPromise = username ? getUserData(username) : $.Deferred().resolve(null).promise();
    let projectMetaPromise = projectId ? getProjectMetaData(projectId) : $.Deferred().resolve({}).promise();
    let agentPromise = $.Deferred().resolve({ device: '', browser: '' }).promise();
    
    // ユーザー情報とプロジェクトメタデータの取得を待つ
    $.when(userPromise, projectMetaPromise)
    .then(function(userDataResult, projectMetaData) {
        let finalUserData = userDataResult;
        
        // 3. ユザネの補完ロジック
        if (!username && !finalUserData && projectMetaData && projectMetaData.author) {
            logToScreen(`3. Project author found. Fetching User Data for: ${projectMetaData.author}`);
            return $.when(getUserData(projectMetaData.author), projectMetaData);
        }
        
        // エージェント解析のPromiseを設定
        if (projectId) {
            agentPromise = analyzeProjectAgent(projectId);
        }

        return $.when(finalUserData, projectMetaData, agentPromise);
    })
    .then(function(userData, projectMetaData, agentData) {
        const finalUserData = (userData && userData.username) ? userData : null;
        const finalProjectData = projectMetaData;
        const finalAgentData = Array.isArray(agentData) ? agentData[0] : agentData; 
        
        logToScreen('[UPDATE] All data collected. Final rendering.');
        
        renderOutput(finalUserData, finalProjectData, finalAgentData);
    })
    .catch(function(reason) {
        logToScreen(`[FATAL] A required API call failed. Reason: ${reason}. Displaying 'error'.`, true);
        $output.text('error');
        $output.css('display', 'block');
    });
}


// 3. ページロード時に処理を開始
$(document).ready(function() {
  document.title = window.location.hostname;
  
  const params = getQueryParameters();
  
  if (params.username || params.projectId) {
    loadAndAnalyzeData(params.username, params.projectId);
  } else {
    // クエリがない場合、Not entered! を表示し、表示を解除する
    $output.text('Not entered!');
    $output.css('display', 'block');
    logToScreen('[END] Blocked: No user or project ID provided. Displaying "Not entered!".');
  }
});
  </script>
</body>
</html>
