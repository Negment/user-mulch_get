<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title></title> 
  
  <style>
    body {
      margin: 0;
      font-family: "Helvetica Neue", "Helvetica", Arial, sans-serif;
      color: #000;
      line-height: 1.5em;
      font-size: 16px;
      background-color: white; 
    }

    #container {
      width: auto;
      margin: 0;
      padding: 10px;
    }

    #result-output {
      white-space: pre-wrap;
      padding: 0;
      border: none;
      background-color: transparent;
      color: #000;
      display: none; 
      font-family: monospace; 
    }
    
    #debug-log {
      margin-top: 20px;
      padding-top: 10px;
      border-top: 1px solid #ccc;
      white-space: pre-wrap;
      font-size: 14px;
      color: #777;
    }
    .error-log {
      color: red;
      font-weight: bold;
    }
    
    #profile-image { display: none; }
  </style>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>
<body>
  <div id="container">
    <p id="result-output"></p> 
    <p id="debug-log"></p> 
  </div>

  <script>
"use strict";

const TURBOWARP_USER_PROXY_BASE = 'https://trampoline.turbowarp.org/proxy/users/';
const TURBOWARP_PROJECT_PROXY_BASE = 'https://trampoline.turbowarp.org/proxy/projects/';
const $output = $('#result-output');
const $debugLog = $('#debug-log');

// --- ヘルパー関数 ---

function logToScreen(message, isError = false) {
    const className = isError ? 'error-log' : '';
    $debugLog.append(`<span class="${className}">[${new Date().toLocaleTimeString()}] ${message}</span><br>`);
}

function getQueryParameters() {
    const urlParams = new URLSearchParams(window.location.search);
    return {
        username: urlParams.get('user') ? urlParams.get('user').trim() : null,
        projectId: urlParams.get('projectId') ? urlParams.get('projectId').trim() : null
    };
}

function jsonToScratchString(obj) {
    let parts = [];
    for (const key in obj) {
        if (!obj.hasOwnProperty(key)) continue;
        const value = typeof obj[key] === 'string' 
            ? `"${obj[key].replace(/\\/g, '\\\\').replace(/"/g, '\\"')}"` 
            : obj[key];
        
        parts.push(`"${key}":${value}`);
    }
    return `{${parts.join(',')}}`;
}


/**
 * 最終結果を整形して出力する関数
 * @param {object} userResult - ユーザーAPIからの最終結果（データまたはステータス）
 * @param {object} projectResult - プロジェクトAPIからの最終結果（データまたはステータス）
 * @param {object} agentData - デバイス/ブラウザ情報
 * @param {string|null} originalUsername - 元のURLクエリのユーザー名
 * @param {string|null} originalProjectId - 元のURLクエリのプロジェクトID
 */
function renderOutput(userResult, projectResult, agentData, originalUsername, originalProjectId) {
    let finalOutputText = '';
    
    // --- 1. ユーザー情報 (JSON形式) ---
    let userOutput = {};
    const userData = userResult.data;

    // ユーザー情報が取得できた場合（補完された場合も含む）
    if (userResult.status === 'Success') {
        userOutput.username = userData.username;
        userOutput.id = userData.id;
        userOutput.joined = userData.history.joined ? new Date(userData.history.joined).toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-') : '';
        userOutput.country = userData.profile.country || '';
        userOutput.images = userData.profile.images['90x90'] ? userData.profile.images['90x90'].split('?')[0] : '';
        userOutput.device = agentData.device || '';
        userOutput.browser = agentData.browser || '';
    } else {
        // ユーザー情報が取得できなかった場合、元のクエリの状態に応じてエラー/無入力を埋める
        const errorValue = (originalUsername === null) ? '無入力' : (userResult.status === 'NotFound' ? 'NotFound' : (userResult.status === 'Invalid' ? '無効' : 'エラー'));
        
        userOutput.username = errorValue;
        userOutput.id = errorValue;
        userOutput.joined = errorValue;
        userOutput.country = errorValue;
        userOutput.images = errorValue;
        userOutput.device = errorValue;
        userOutput.browser = errorValue;
    }
    
    if (Object.keys(userOutput).length > 0) {
        finalOutputText += jsonToScratchString(userOutput);
    }
    
    // --- 2. プロジェクト情報 (JSON形式) ---
    let projectOutput = {};
    const projectData = projectResult.data;

    if (projectResult.status === 'Success') {
        projectOutput.project_id = projectData.id;
        projectOutput.title = projectData.title || '';
        projectOutput.visibility = projectData.visibility || '';
        projectOutput.author = projectData.author || '';

        // ユーザー情報にデバイス情報がない場合のみ、プロジェクト側で表示
        if (userResult.status !== 'Success') {
            projectOutput.device = agentData.device || '';
            projectOutput.browser = agentData.browser || '';
        }
    } else {
        // プロジェクト情報が取得できなかった場合
        const errorValue = (originalProjectId === null) ? '無入力' : (projectResult.status === 'NotFound' ? 'NotFound' : (projectResult.status === 'Invalid' ? '無効' : 'エラー'));
        
        projectOutput.project_id = errorValue;
        projectOutput.title = errorValue;
        projectOutput.visibility = errorValue;
        projectOutput.author = errorValue;

        if (userResult.status !== 'Success') {
            projectOutput.device = errorValue;
            projectOutput.browser = errorValue;
        }
    }

    if (Object.keys(projectOutput).length > 0) {
        if (finalOutputText.length > 0) finalOutputText += '<br>';
        finalOutputText += jsonToScratchString(projectOutput);
    }
    
    // --- 3. 最終出力処理 ---
    if (finalOutputText.length > 0) {
        $output.html(finalOutputText);
        $output.css('display', 'block');
        logToScreen('[END] Output successful.');
    } else {
        // どちらもクエリがない状態は、初期の "Not entered!" で処理されるため、ここは通常実行されない
        $output.text('致命的エラー'); 
        $output.css('display', 'block');
        logToScreen('[END] Output: FATAL ERROR (Should not happen).');
    }
}

// プロジェクトIDからデバイス/ブラウザ情報を取得する
function analyzeProjectAgent(projectId) {
    logToScreen(`4. Start Project Agent Analysis for ID: ${projectId}`);
    let deviceOutput = '';
    let browserOutput = '';
    
    return $.ajax({
        url: TURBOWARP_PROJECT_PROXY_BASE + projectId,
        dataType: "json",
    })
    .then(function (tokenData) {
        if (tokenData.error) {
            return $.Deferred().reject('Token JSON Error').promise();
        }
        let token = tokenData["project_token"];
        return $.ajax({
            url: `https://projects.scratch.mit.edu/${projectId}/?token=${token}`,
            dataType: "text",
        });
    })
    .then(function (projectJson) {
        const agentRegex = /"agent"\s*:\s*"(.+?)"/s;
        const match = projectJson.match(agentRegex);
        
        if (match && match[1]) {
            const userAgent = match[1];
            
             if (/Windows NT 10.0/.test(userAgent)) { deviceOutput = 'Windows 10/11'; } 
            else if (/iPhone/.test(userAgent)) { deviceOutput = 'iPhone (iOS)'; } 
            else if (/iPad/.test(userAgent)) { deviceOutput = 'iPad (iPadOS)'; } 
            else if (/Mac OS X/.test(userAgent) && !/iPhone|iPad/.test(userAgent)) { deviceOutput = 'Mac (macOS)'; } 
            else if (/Android/.test(userAgent)) { deviceOutput = 'Android'; } 
            else if (/Linux/.test(userAgent)) { deviceOutput = 'Linux'; }
            
            if (/CriOS\/(\d+\.\d+)/.test(userAgent)) { browserOutput = 'Chrome for iOS (CriOS)'; } 
            else if (/Edg\/(\d+\.\d+)/.test(userAgent)) { browserOutput = 'Edge'; } 
            else if (/Chrome\/(\d+\.\d+)/.test(userAgent)) { browserOutput = 'Chrome'; } 
            else if (/Safari\/(\d+\.\d+)/.test(userAgent) && !/Chrome|CriOS/.test(userAgent)) { browserOutput = 'Safari'; } 
            else if (/Firefox\/(\d+\.\d+)/.test(userAgent)) { browserOutput = 'Firefox'; }
        }
        return { device: deviceOutput, browser: browserOutput };
    })
    .catch(function(error) {
        logToScreen(`4. Project Agent Analysis failed.`, true);
        return { device: '', browser: '' }; 
    });
}

// プロジェクトIDからメタデータを取得する
function getProjectMetaData(projectId) {
    return $.ajax({
        url: `https://api.scratch.mit.edu/projects/${projectId}`, 
        dataType: 'json',
    })
    .then(function(response) {
        if (response.error === 'Resource does not exist') {
             return { status: 'NotFound', data: null };
        }
        if (response.error === 'Invalid project ID') {
             return { status: 'Invalid', data: null };
        }
        
        return {
            data: {
                id: response.id,
                title: response.title,
                visibility: response.visibility,
                author: response.author ? response.author.username : null
            },
            status: 'Success'
        };
    })
    .catch(function(error) {
        logToScreen(`2. Project Meta Data API failed.`, true);
        return { status: 'Error', data: null }; 
    });
}

// ユーザーIDからユーザー情報を取得する
function getUserData(username) {
    return $.ajax({
        url: TURBOWARP_USER_PROXY_BASE + username,
        dataType: 'json',
    })
    .then(function(userData) {
        if (userData.error === 'Resource does not exist' || userData.error === 'NotFound') {
            return { status: 'NotFound', data: null };
        }
        if (userData.error === 'Invalid username') {
            return { status: 'Invalid', data: null };
        }
        
        return { data: userData, status: 'Success' };
    })
    .catch(function(reason) {
        const status = reason && reason.status ? reason.status : 'N/A';
        if (status === 404 || status === 400) {
            return { status: 'NotFound', data: null };
        }
        logToScreen(`1d. Unhandled User API Error.`, true);
        return { status: 'Error', data: null };
    });
}


/**
 * メインのデータ取得ロジック (補完処理を含む)
 */
function loadAndAnalyzeData(username, projectId) {
    logToScreen(`[START] Analyzing Data (User: ${username || 'N/A'}, Project: ${projectId || 'N/A'})`);
    
    let userPromise = username ? getUserData(username) : $.Deferred().resolve({ status: 'NoInput', data: null }).promise();
    let projectMetaPromise = projectId ? getProjectMetaData(projectId) : $.Deferred().resolve({ status: 'NoInput', data: null }).promise();
    
    // ユーザー情報とプロジェクトメタデータの取得を待つ (第1フェーズ)
    $.when(userPromise, projectMetaPromise)
    .then(function(userResult, projectResult) {
        let finalUserResult = userResult;
        
        // 補完の条件: 
        // 1. 元のユザネクエリが成功していない (NoInput, NotFound, Invalid, Error)
        // 2. プロジェクトIDが有効で、作者名を持っている
        const userFailed = finalUserResult.status !== 'Success';
        const canAutocomplete = (projectResult.status === 'Success' && projectResult.data.author);
        
        if (userFailed && canAutocomplete) {
            logToScreen(`3. Autocompletion triggered for author: ${projectResult.data.author}`);
            // プロジェクト作者のユーザー情報を取得する (第2フェーズ)
            // この結果が finalUserResult を上書きする
            return $.when(getUserData(projectResult.data.author), projectResult);
        }
        
        // エージェント解析のPromiseを設定 (プロジェクトIDが有効な場合のみ)
        let agentPromise = $.Deferred().resolve({ device: '', browser: '' }).promise();
        if (projectResult.status === 'Success') {
            agentPromise = analyzeProjectAgent(projectId);
        }

        return $.when(finalUserResult, projectResult, agentPromise);
    })
    .then(function(userResult, projectResult, agentData) {
        // 補完フェーズで取得された場合、userResultが更新されている
        const finalAgentData = Array.isArray(agentData) ? agentData[0] : agentData; 
        
        logToScreen('[UPDATE] All data collected. Final rendering.');
        
        renderOutput(userResult, projectResult, finalAgentData, username, projectId);
    })
    .catch(function(reason) {
        logToScreen(`[FATAL] A required API call failed. Reason: ${reason}. Displaying 'error'.`, true);
        $output.text('error');
        $output.css('display', 'block');
    });
}


// 3. ページロード時に処理を開始
$(document).ready(function() {
  document.title = window.location.hostname;
  
  const params = getQueryParameters();
  
  if (params.username || params.projectId) {
    loadAndAnalyzeData(params.username, params.projectId);
  } else {
    // クエリがない場合、Not entered! を表示し、表示を解除する
    $output.text('Not entered!');
    $output.css('display', 'block');
    logToScreen('[END] Blocked: No user or project ID provided. Displaying "Not entered!".');
  }
});
  </script>
</body>
</html>
