<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scratch Data Analyzer</title> 
  
  <style>
    :root {
      --bg-color: #f9f9f9;
      --card-bg: #ffffff;
      --text-color: #333;
      --accent-color: #4d97ff; /* Scratch Blue */
      --json-key: #d32f2f;
      --json-string: #2e7d32;
      --json-number: #1565c0;
      --json-boolean: #ef6c00;
    }

    body {
      margin: 0;
      font-family: "Helvetica Neue", "Helvetica", Arial, sans-serif;
      color: var(--text-color);
      line-height: 1.6em;
      font-size: 16px;
      background-color: var(--bg-color);
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    #container {
      width: 100%;
      max-width: 800px;
      margin: 20px;
      padding: 20px;
      background-color: var(--card-bg);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      border-radius: 8px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }

    /* ローディング表示 */
    #loading {
      text-align: center;
      padding: 40px;
      font-weight: bold;
      color: #666;
      display: none; /* JSで制御 */
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--accent-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* 結果表示エリア */
    #result-output {
      white-space: pre-wrap;
      font-family: "Monaco", "Consolas", monospace;
      font-size: 14px;
      background-color: #f4f4f4;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #ddd;
      overflow-x: auto;
      display: none;
    }

    /* JSONシンタックスハイライト */
    .json-key { color: var(--json-key); }
    .json-string { color: var(--json-string); }
    .json-number { color: var(--json-number); }
    .json-boolean { color: var(--json-boolean); font-weight: bold; }
    .json-null { color: #757575; font-style: italic; }

    /* デバッグログ */
    #debug-log {
      margin-top: 20px;
      padding-top: 10px;
      border-top: 2px dashed #ccc;
      font-size: 12px;
      color: #555;
      font-family: monospace;
      display: none; /* デフォルト非表示 */
    }
    .error-log { color: #d32f2f; font-weight: bold; }
    .json-log {
      margin: 5px 0;
      padding: 5px;
      background: #eee;
      border-left: 3px solid #999;
    }

    /* デバッグモードでない場合はログ領域をDOMから消すためのクラス */
    .no-debug-view #debug-log {
        display: none !important;
    }
  </style>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>
<body>
  <div id="container">
    <div id="loading">
      <div class="spinner"></div>
      <div>Processing Data...</div>
    </div>

    <div id="result-output"></div> 

    <div id="debug-log"></div> 
  </div>

  <script>
"use strict";

const VERSION = "5.1.0 (Refined)";
const TURBOWARP_USER_PROXY_BASE = 'https://trampoline.turbowarp.org/proxy/users/';
const TURBOWARP_PROJECT_PROXY_BASE = 'https://trampoline.turbowarp.org/proxy/projects/';
const SCRATCH_API_PROJECT_BASE = 'https://api.scratch.mit.edu/projects/';
const $output = $('#result-output');
const $debugLog = $('#debug-log');
const $loading = $('#loading');
let DEBUG_MODE = false;

// --- ステータス定数 ---
const STATUS_SUCCESS = 'Success';
const STATUS_NOT_FOUND = 'Resource does not exist';
const STATUS_INVALID = 'Invalid username'; 
const STATUS_INVALID_PROJECT = 'Invalid project ID';
const STATUS_ERROR = 'Error';
const STATUS_NO_INPUT = 'No input';
const STATUS_NOT_REGISTERED = 'Account not registered';
const STATUS_ACCOUNT_INVALID = 'Account invalid';

// --- ヘルパー関数 ---

function logToScreen(message, isError = false) {
    if (!DEBUG_MODE) return;
    const className = isError ? 'error-log' : '';
    const time = new Date().toLocaleTimeString();
    $debugLog.append(`<div class="${className}">[${time}] ${message}</div>`);
}

function logJson(label, data) {
    if (!DEBUG_MODE) return;
    let jsonString = '';
    try {
        jsonString = JSON.stringify(data, null, 2);
    } catch(e) {
        jsonString = '--- JSON serialization error ---';
    }
    $debugLog.append(`<div class="json-log"><strong>${label}:</strong><pre>${jsonString}</pre></div>`);
}

function getQueryParameters() {
    const urlParams = new URLSearchParams(window.location.search);
    const debugParam = urlParams.get('debug');
    
    if (debugParam === 'true' || debugParam === '') {
        DEBUG_MODE = true;
        $debugLog.show();
    } else {
        DEBUG_MODE = false;
        $('body').addClass('no-debug-view');
    }
    
    return {
        username: urlParams.get('username') ? urlParams.get('username').trim() : null,
        projectId: urlParams.get('projectId') ? urlParams.get('projectId').trim() : null
    };
}

/**
 * JSONをHTMLで見やすくハイライトする関数
 */
function syntaxHighlight(json) {
    if (typeof json !== 'string') {
        json = JSON.stringify(json, undefined, 2);
    }
    json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
        let cls = 'json-number';
        if (/^"/.test(match)) {
            if (/:$/.test(match)) {
                cls = 'json-key';
            } else {
                cls = 'json-string';
            }
        } else if (/true|false/.test(match)) {
            cls = 'json-boolean';
        } else if (/null/.test(match)) {
            cls = 'json-null';
        }
        return '<span class="' + cls + '">' + match + '</span>';
    });
}

function displayResult(result) {
    logToScreen('[DEBUG] Displaying result.'); 
    $loading.hide(); // ロード画面を隠す
    
    try {
        // オブジェクトの場合はハイライト関数を通す
        const html = syntaxHighlight(result);
        $output.html(html).fadeIn();
    } catch (e) {
        logToScreen('FATAL ERROR: JSON Display failed. ' + e.message, true);
        $output.text('FATAL JSON ERROR');
        $output.show();
    }
    
    if (!DEBUG_MODE) {
        $('#debug-log').remove();
    }
}

// --- API関数群 ---

function getUserData(username) {
    logToScreen(`1. Fetching User Data for: ${username}`);
    return $.ajax({
        url: TURBOWARP_USER_PROXY_BASE + username,
        dataType: 'json',
    })
    .then(function(userData) {
        logJson('User Proxy Response', userData); 
        if (userData.error === 'Resource does not exist' || userData.error === 'NotFound') {
            return { status: STATUS_NOT_FOUND, data: null };
        }
        if (userData.error === 'Invalid username') {
            return { status: STATUS_INVALID, data: null };
        }
        return { 
            status: STATUS_SUCCESS, 
            data: {
                username: userData.username,
                id: userData.id,
                joined: userData.history.joined ? new Date(userData.history.joined).toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-') : '',
                country: userData.profile.country || '',
                images: userData.profile.images['90x90'] ? userData.profile.images['90x90'].split('?')[0] : '',
            }
        };
    })
    .catch(function(jqXHR) {
        if (jqXHR.status === 404) {
            logToScreen(`1. User API 404.`, true);
            return { status: STATUS_NOT_FOUND, data: null };
        }
        logToScreen(`1. User API failed (Status: ${jqXHR.status}).`, true);
        return { status: STATUS_INVALID, data: null };
    });
}

async function getProjectMetaData(projectId) {
    logToScreen(`2. Fetching Project Meta Data for ID: ${projectId}`);
    
    let authorUsername = null;
    let projectIdInJson = null;
    let title = null;
    let status = STATUS_ERROR;

    try {
        const tokenPromise = $.ajax({
            url: TURBOWARP_PROJECT_PROXY_BASE + projectId,
            dataType: "json",
        }).then(data => data)
        .catch(jqXHR => {
            if (jqXHR.status === 404) return { error: 'Resource does not exist' }; 
            return { error: 'Proxy Network Error' };
        });

        const tokenData = await tokenPromise;
        logJson('Project Proxy Response', tokenData); 

        if (tokenData.error) {
            status = (tokenData.error === 'Resource does not exist' || tokenData.error === 'NotFound') ? STATUS_NOT_FOUND :
                     (tokenData.error === 'Invalid project ID') ? STATUS_INVALID_PROJECT : STATUS_ERROR;
            return { status: status, data: null }; 
        }
        
        // 成功ルート1: Proxyから直接取得
        if (tokenData.author && tokenData.author.username) {
            return {
                data: {
                    author: tokenData.author.username,
                    id: tokenData.id,
                    title: tokenData.title,
                    visibility: tokenData.visibility || 'visible', 
                },
                status: STATUS_SUCCESS
            };
        }
        
        // 成功ルート2: フルJSONから取得
        logToScreen('2. Author not in metadata, fetching full JSON.');
        const projectJsonText = await $.ajax({
            url: `https://projects.scratch.mit.edu/${projectId}/?token=${tokenData["project_token"]}`,
            dataType: "text",
        });
        
        try {
            const projectJson = JSON.parse(projectJsonText);
            if (projectJson?.author?.username) {
                authorUsername = projectJson.author.username;
                projectIdInJson = projectJson.id;
                title = projectJson.title;
                status = STATUS_SUCCESS;
            } else {
                throw new Error("Author field missing.");
            }
        } catch(e) {
            // 成功ルート3: 正規表現フォールバック
            logToScreen('2. JSON parse failed/missing. Regex fallback.');
            const authorMatch = projectJsonText.match(/"author":\s*\{[^}]*?"username"\s*:\s*"([^"]+)"/s);
            const idMatch = projectJsonText.match(/"id"\s*:\s*(\d+)/);
            
            if (authorMatch) {
                authorUsername = authorMatch[1];
                projectIdInJson = idMatch ? idMatch[1] : null;
                status = STATUS_SUCCESS;
            }
        }
        
        if (status === STATUS_SUCCESS) {
            return {
                data: { author: authorUsername, id: projectIdInJson, title: title, visibility: 'visible' },
                status: STATUS_SUCCESS
            };
        }

    } catch(e) {
        logToScreen(`2. Metadata extraction failed. Error: ${e.message}`, true);
    }
    
    // 成功ルート4: Scratch API フォールバック
    if (status !== STATUS_SUCCESS) {
        logToScreen('2. Fallback to Scratch API.');
        try {
            const metaData = await $.ajax({ url: SCRATCH_API_PROJECT_BASE + projectId, dataType: "json" });
            if (metaData?.author?.username) {
                return {
                    data: { author: metaData.author.username, id: metaData.id, title: metaData.title, visibility: 'visible' },
                    status: STATUS_SUCCESS
                };
            }
            status = STATUS_NOT_FOUND;
        } catch(jqXHR) {
             status = (jqXHR.status === 404) ? STATUS_NOT_FOUND : STATUS_ERROR;
        }
    }

    return { status: status, data: null };
}

function analyzeProjectAgent(projectId) {
    logToScreen(`3. Analyzing Project Agent for ID: ${projectId}`);
    
    return $.ajax({
        url: TURBOWARP_PROJECT_PROXY_BASE + projectId,
        dataType: "json",
    })
    .then(tokenData => {
        if (tokenData.error) return $.Deferred().reject('Token Error').promise();
        return $.ajax({
            url: `https://projects.scratch.mit.edu/${projectId}/?token=${tokenData["project_token"]}`,
            dataType: "text",
        });
    })
    .then(projectJson => {
        const match = projectJson.match(/"agent"\s*:\s*"(.+?)"/s);
        if (!match || !match[1]) return { device: 'ResourceNotFound', browser: 'ResourceNotFound' };
        
        const userAgent = match[1];
        let device = 'Unknown Device';
        let browser = 'Unknown Browser';
        
        // Device Parsing
        const osPart = userAgent.match(/\((.*?)\)/);
        if (osPart && osPart[1]) device = osPart[1].trim().replace(/; /g, ', ');
        else if (device === 'Unknown Device' && osPart) device = osPart[1]; // Fallback

        // Browser Parsing
        const browserPart = userAgent.match(/(Chrome|CriOS|Firefox|Edg|Safari)\/(\d+(\.\d+){1,3})/g);
        if (browserPart && browserPart.length > 0) browser = browserPart.join(', ');
        else if (userAgent.includes("Trident")) browser = "Internet Explorer";

        return { device: device, browser: browser };
    })
    .catch(() => {
        return { device: 'ResourceNotFound', browser: 'ResourceNotFound' };
    });
}

// --- メイン処理フロー (ロジックはオリジナルを維持) ---

async function mainFlow() {
    $loading.show(); // ローディング開始
    
    const params = getQueryParameters();
    const ユザネ = params.username;
    const プロ番 = params.projectId;

    logToScreen(`[FLOW] Start processing (User: ${ユザネ}, Project: ${プロ番})`);

    if (!ユザネ) {
        if (!プロ番) {
            return displayResult({code:"ResourceNotFound", message:"'username' and 'projectId' do not exist."});
        } else {
            await BA_Flow(プロ番);
        }
    } else {
        if (!プロ番) {
            await AB_Flow(ユザネ);
        } else {
            await AA_Flow(ユザネ, プロ番);
        }
    }
}

async function AB_Flow(ユザネ) {
    const userResult = await getUserData(ユザネ);
    if (userResult.status === STATUS_SUCCESS) {
        return displayResult({
            "username": userResult.data.username,
            "id": userResult.data.id,
            "joined": userResult.data.joined,
            "country": userResult.data.country,
            "images": userResult.data.images,
            "device": "ResourceNotFound",
            "browser": "ResourceNotFound",
            "message": "'projectId' do not exist."
        });
    } else if (userResult.status === STATUS_NOT_FOUND) {
        return displayResult({
            "code":"ResourceNotFound", 
            "username": ユザネ, 
            "id": "ResourceNotFound",
            "joined": "ResourceNotFound",
            "country": "ResourceNotFound",
            "images": "ResourceNotFound",
            "device": "ResourceNotFound",
            "browser": "ResourceNotFound",
            "message":"'username' is not registered and 'projectId' do not exist."
        });
    } else if (userResult.status === STATUS_INVALID) {
        return displayResult({
            "code":"Invalid username", 
            "username": ユザネ, 
            "id": "ResourceNotFound",
            "joined": "ResourceNotFound",
            "country": "ResourceNotFound",
            "images": "ResourceNotFound",
            "device": "ResourceNotFound",
            "browser": "ResourceNotFound",
            "message":"'username' is invalid and 'projectId' do not exist."
        });
    }
}

async function BA_Flow(プロ番) {
    const projectResult = await getProjectMetaData(プロ番);
    if (projectResult.status === STATUS_SUCCESS) {
        await BA1_Flow(projectResult.data.author, projectResult.data.id, プロ番);
    } else if (projectResult.status === STATUS_NOT_FOUND) { 
        return displayResult({
            "code":"ResourceNotFound",
            "message":"'username' do not exist and 'projectId' is not shared."
        });
    } else { 
        return displayResult({
            "code":"Invalid project ID", 
            "message":"'username' do not exist and 'projectId' is invalid."
        });
    }
}

async function BA1_Flow(authorUsername, projectId, プロ番) {
    const agentData = await analyzeProjectAgent(プロ番);
    if (!authorUsername) {
         return displayResult({
            "username": null, 
            "id": "ResourceNotFound",
            "joined": "ResourceNotFound",
            "country": "ResourceNotFound",
            "images": "ResourceNotFound",
            "device": agentData.device,
            "browser": agentData.browser,
            "message": "'username' is not registered." 
        });
    }
    const userResult = await getUserData(authorUsername);

    if (userResult.status === STATUS_SUCCESS) {
        return displayResult({
            "username": userResult.data.username,
            "id": userResult.data.id,
            "joined": userResult.data.joined,
            "country": userResult.data.country,
            "images": userResult.data.images,
            "device": agentData.device,
            "browser": agentData.browser,
            "message": "'username' do not exist."
        });
    } else if (userResult.status === STATUS_NOT_FOUND) {
        return displayResult({
            "username": authorUsername, 
            "id": "ResourceNotFound",
            "joined": "ResourceNotFound",
            "country": "ResourceNotFound",
            "images": "ResourceNotFound",
            "device": agentData.device,
            "browser": agentData.browser,
            "message": "'username' is not registered."
        });
    } else {
         return displayResult({
            "username": authorUsername, 
            "id": "ResourceNotFound",
            "joined": "ResourceNotFound",
            "country": "ResourceNotFound",
            "images": "ResourceNotFound",
            "device": agentData.device,
            "browser": agentData.browser,
            "message": "'username' is invalid."
        });
    }
}

async function AA_Flow(ユザネ, プロ番) {
    const userResult = await getUserData(ユザネ);
    let userState = STATUS_SUCCESS;
    let userData = userResult.data || {};

    if (userResult.status === STATUS_NOT_FOUND) userState = STATUS_NOT_REGISTERED;
    else if (userResult.status === STATUS_INVALID) userState = STATUS_ACCOUNT_INVALID;
    
    const agentData = await analyzeProjectAgent(プロ番);
    const projectResult = await getProjectMetaData(プロ番);
    let projectData = projectResult.data || {};

    if (projectResult.status === STATUS_SUCCESS) {
        await AA1A_Flow(ユザネ, userData, userState, agentData, projectData);
    } else if (projectResult.status === STATUS_NOT_FOUND) {
        await AA1B_Flow(ユザネ, userState, userData, agentData);
    } else {
        await AA1C_Flow(ユザネ, userState, userData, agentData);
    }
}

async function AA1A_Flow(ユザネ, userData, userState, agentData, projectData) {
    let projectAuthorData = {};
    if (projectData.author) {
        const authorResult = await getUserData(projectData.author);
        projectAuthorData = authorResult.data || {};
    }
    
    const isMatched = (userState === STATUS_SUCCESS && userData.username === projectData.author);
    
    if (userState === STATUS_SUCCESS) {
        if (isMatched) {
            return displayResult({
                "username": userData.username,
                "id": userData.id,
                "joined": userData.joined,
                "country": userData.country,
                "images": userData.images,
                "device": agentData.device,
                "browser": agentData.browser
            });
        } else {
            return displayResult({
                "code": "Not correspond",
                "message": "'username' and 'projectId' do not correspond."
            });
        }
    } else if (userState === STATUS_NOT_REGISTERED) {
        return displayResult({
            "username": projectData.author,
            "id": projectAuthorData.id || "ResourceNotFound",
            "joined": projectAuthorData.joined || "ResourceNotFound",
            "country": projectAuthorData.country || "ResourceNotFound",
            "images": projectAuthorData.images || "ResourceNotFound",
            "device": agentData.device,
            "browser": agentData.browser,
            "message": `'input username' (${ユザネ}) is not registered.`
        });
    } else if (userState === STATUS_ACCOUNT_INVALID) {
        return displayResult({
            "username": projectData.author,
            "id": projectAuthorData.id || "ResourceNotFound",
            "joined": projectAuthorData.joined || "ResourceNotFound",
            "country": projectAuthorData.country || "ResourceNotFound",
            "images": projectAuthorData.images || "ResourceNotFound",
            "device": agentData.device,
            "browser": agentData.browser,
            "message": `'input username' (${ユザネ}) is invalid.`
        });
    }
}

async function AA1B_Flow(ユザネ, userState, userData, agentData) {
    if (userState === STATUS_SUCCESS) {
        return displayResult({
            "username": userData.username,
            "id": userData.id,
            "joined": userData.joined,
            "country": userData.country,
            "images": userData.images,
            "device": "ResourceNotFound",
            "browser": "ResourceNotFound",
            "message": "'projectId' is not shared."
        });
    } else if (userState === STATUS_NOT_REGISTERED) {
        return displayResult({
            "code": "ResourceNotFound",
            "username": ユザネ,
            "id": "ResourceNotFound",
            "joined": "ResourceNotFound",
            "country": "ResourceNotFound",
            "images": "ResourceNotFound",
            "device": "ResourceNotFound",
            "browser": "ResourceNotFound",
            "message": `'input username' (${ユザネ}) is not registered and 'projectId' is not shared.`
        });
    } else if (userState === STATUS_ACCOUNT_INVALID) {
        return displayResult({
            "code": "Invalid username",
            "username": ユザネ,
            "id": "ResourceNotFound",
            "joined": "ResourceNotFound",
            "country": "ResourceNotFound",
            "images": "ResourceNotFound",
            "device": "ResourceNotFound",
            "browser": "ResourceNotFound",
            "message": `'input username' (${ユザネ}) is invalid and 'projectId' is not shared.`
        });
    }
}

async function AA1C_Flow(ユザネ, userState, userData, agentData) {
    if (userState === STATUS_SUCCESS) {
        return displayResult({
            "username": userData.username,
            "id": userData.id,
            "joined": userData.joined,
            "country": userData.country,
            "images": userData.images,
            "device": "ResourceNotFound",
            "browser": "ResourceNotFound",
            "message": "'projectId' is invalid."
        });
    } else if (userState === STATUS_NOT_REGISTERED) {
        return displayResult({
            "code": "ResourceNotFound",
            "username": ユザネ,
            "id": "ResourceNotFound",
            "joined": "ResourceNotFound",
            "country": "ResourceNotFound",
            "images": "ResourceNotFound",
            "device": "ResourceNotFound",
            "browser": "ResourceNotFound",
            "message": `'input username' (${ユザネ}) is not registered and 'projectId' is invalid.`
        });
    } else if (userState === STATUS_ACCOUNT_INVALID) {
        return displayResult({
            "code": "Invalid username",
            "username": ユザネ,
            "id": "ResourceNotFound",
            "joined": "ResourceNotFound",
            "country": "ResourceNotFound",
            "images": "ResourceNotFound",
            "device": "ResourceNotFound",
            "browser": "ResourceNotFound",
            "message": `'input username' (${ユザネ}) is invalid and 'projectId' is invalid.`
        });
    }
}

$(document).ready(function() {
    mainFlow();
});
  </script>
</body>
</html>
