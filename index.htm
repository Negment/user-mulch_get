<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title></title> 
  
  <style>
    body {
      margin: 0;
      font-family: "Helvetica Neue", "Helvetica", Arial, sans-serif;
      color: #000;
      line-height: 1.5em;
      font-size: 16px;
      background-color: white; 
    }

    #container {
      width: auto;
      margin: 0;
      padding: 10px;
    }

    #result-output {
      white-space: pre-wrap;
      padding: 0;
      border: none;
      background-color: transparent;
      color: #000;
    }
    
    #profile-image {
      display: none;
    }
  </style>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>
<body>
  <div id="container">
    <p id="result-output">データを読み込み中です...</p>
  </div>

  <script>
"use strict";

// TurboWarpのユーザー情報プロキシベースURLを使用
const TURBOWARP_USER_PROXY_BASE = 'https://trampoline.turbowarp.org/proxy/users/';
const $output = $('#result-output');

/**
 * URLクエリから 'user' パラメータの値 (ユーザー名) を取得する関数
 */
function getUsernameFromUrl() {
  const urlParams = new URLSearchParams(window.location.search);
  const username = urlParams.get('user');
  return username ? username.trim() : null;
}

/**
 * プロジェクトIDからデバイス/ブラウザ情報を取得するPromise関数
 */
function analyzeProjectAgent(projectId) {
    let deviceOutput = '';
    let browserOutput = '';
    
    // 既存のTurboWarpプロキシ（プロジェクトトークン取得）はそのまま利用
    return $.ajax({
        url: `https://trampoline.turbowarp.org/proxy/projects/${projectId}`,
        dataType: "json",
    })
    .then(function (tokenData) {
        let token = tokenData["project_token"];
        // 実際のプロジェクトJSON取得
        return $.ajax({
            url: `https://projects.scratch.mit.edu/${projectId}/?token=${token}`,
            dataType: "text",
        });
    })
    .then(function (projectJson) {
        const agentRegex = /"agent"\s*:\s*"(.+?)"/s;
        const match = projectJson.match(agentRegex);
        
        if (match && match[1]) {
            const userAgent = match[1];
            
            // OSの判定
            if (/Windows NT 10.0/.test(userAgent)) { deviceOutput = 'Windows 10/11'; } 
            else if (/iPhone/.test(userAgent)) { deviceOutput = 'iPhone (iOS)'; } 
            else if (/iPad/.test(userAgent)) { deviceOutput = 'iPad (iPadOS)'; } 
            else if (/Mac OS X/.test(userAgent) && !/iPhone|iPad/.test(userAgent)) { deviceOutput = 'Mac (macOS)'; } 
            else if (/Android/.test(userAgent)) { deviceOutput = 'Android'; } 
            else if (/Linux/.test(userAgent)) { deviceOutput = 'Linux'; }
            
            // ブラウザの判定
            if (/CriOS\/(\d+\.\d+)/.test(userAgent)) { browserOutput = 'Chrome for iOS (CriOS)'; } 
            else if (/Edg\/(\d+\.\d+)/.test(userAgent)) { browserOutput = 'Edge'; } 
            else if (/Chrome\/(\d+\.\d+)/.test(userAgent)) { browserOutput = 'Chrome'; } 
            else if (/Safari\/(\d+\.\d+)/.test(userAgent) && !/Chrome|CriOS/.test(userAgent)) { browserOutput = 'Safari'; } 
            else if (/Firefox\/(\d+\.\d+)/.test(userAgent)) { browserOutput = 'Firefox'; }
        }
        return { device: deviceOutput, browser: browserOutput };
    })
    .catch(function() {
        return { device: '', browser: '' };
    });
}

/**
 * メインのデータ取得ロジック
 */
function loadAndAnalyzeUser(username) {
    let userData = null;
    let messageCount = '取得失敗';

    // 1. ユーザー情報 API (TurboWarpプロキシ経由)
    $.ajax({
        url: TURBOWARP_USER_PROXY_BASE + username,
        dataType: 'json',
    })
    .then(function(response) {
        // --- ユーザー存在チェック (NotFound) ---
        if (response.error === 'Invalid username') {
            $output.text('NotFound');
            return $.Deferred().reject('HANDLED');
        }
        
        userData = response;
        
        // 2. メッセージ数 API と 3. プロジェクト API を並行実行 ($.when)
        return $.when(
            // 2. メッセージ数 (TurboWarpプロキシ経由)
            $.ajax({ 
                url: TURBOWARP_USER_PROXY_BASE + username + '/messages/count', 
                dataType: 'json' 
            })
            .then(function(countData) {
                messageCount = countData.count !== undefined ? countData.count : 'N/A';
                return null;
            })
            .catch(function() {
                messageCount = '取得失敗';
                return null;
            }),
                
            // 3. プロジェクトリスト (TurboWarpプロキシ経由)
            $.ajax({ 
                url: TURBOWARP_USER_PROXY_BASE + username + '/projects/?limit=1&offset=0', 
                dataType: 'json' 
            })
            .then(function(projectsData) {
                if (Array.isArray(projectsData) && projectsData.length > 0) {
                    const latestProjectId = projectsData[0].id;
                    return analyzeProjectAgent(latestProjectId); // 4. デバイス/ブラウザ解析へ
                }
                return { device: '', browser: '' };
            })
            .catch(function() {
                return { device: '', browser: '' };
            })
        );
    })
    .then(function(results) {
        const agentData = results[1];

        // データの整形
        const userName = userData.username || 'N/A';
        const userId = userData.id || 'N/A';
        const joinedDate = userData.history.joined ? new Date(userData.history.joined).toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-') : 'N/A';
        const country = userData.profile.country || 'N/A';
        const imageUrl = userData.profile.images['90x90'] || '';
        
        // 最終出力
        let outputText = '';
        outputText += `username: ${userName}<br>`;
        outputText += `id: ${userId}<br>`;
        outputText += `joined: ${joinedDate}<br>`;
        outputText += `country: ${country}<br>`;
        outputText += `images: ${imageUrl}<br>`;
        outputText += `Unread count: ${messageCount}`;
        
        // デバイス/ブラウザ情報がある場合のみ追記
        if (agentData.device) {
            outputText += `<br>device: ${agentData.device}`;
        }
        if (agentData.browser) {
            outputText += `<br>browser: ${agentData.browser}`;
        }

        $output.html(outputText);
    })
    .catch(function(reason) {
        // HANDLED (NotFound) 以外は 'error'
        if (reason !== 'HANDLED') {
            $output.text('error');
        }
    });
}


// 3. ページロード時に処理を開始
$(document).ready(function() {
  document.title = window.location.hostname;
  
  const username = getUsernameFromUrl();
  
  // --- 空白入力の事前ブロック ---
  if (username && username.length > 0) {
    loadAndAnalyzeUser(username);
  } else {
    $output.text('Not entered!');
  }
});
  </script>
</body>
</html>
