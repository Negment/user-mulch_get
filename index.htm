<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title></title> 
  
  <style>
    body {
      margin: 0;
      font-family: "Helvetica Neue", "Helvetica", Arial, sans-serif;
      color: #000;
      line-height: 1.5em;
      font-size: 16px;
      background-color: white; 
    }

    #container {
      width: auto;
      margin: 0;
      padding: 10px;
    }

    #result-output {
      /* 結果が出るまで完全に非表示 */
      white-space: pre-wrap;
      padding: 0;
      border: none;
      background-color: transparent;
      color: #000;
      display: none; 
    }
    
    /* デバッグログ専用のスタイル */
    #debug-log {
      margin-top: 20px;
      padding-top: 10px;
      border-top: 1px solid #ccc;
      white-space: pre-wrap;
      font-size: 14px;
      color: #777;
    }
    .error-log {
      color: red;
      font-weight: bold;
    }
    
    #profile-image { display: none; }
  </style>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>
<body>
  <div id="container">
    <p id="result-output"></p> 
    <p id="debug-log"></p> 
  </div>

  <script>
"use strict";

const TURBOWARP_USER_PROXY_BASE = 'https://trampoline.turbowarp.org/proxy/users/';
const TURBOWARP_PROJECT_PROXY_BASE = 'https://trampoline.turbowarp.org/proxy/projects/';
const $output = $('#result-output');
const $debugLog = $('#debug-log');

// --- ヘルパー関数 ---

function logToScreen(message, isError = false) {
    const className = isError ? 'error-log' : '';
    $debugLog.append(`<span class="${className}">[${new Date().toLocaleTimeString()}] ${message}</span><br>`);
}

/**
 * URLクエリパラメータから user と projectId を取得する
 */
function getQueryParameters() {
    const urlParams = new URLSearchParams(window.location.search);
    return {
        username: urlParams.get('user') ? urlParams.get('user').trim() : null,
        projectId: urlParams.get('projectId') ? urlParams.get('projectId').trim() : null
    };
}

/**
 * JSオブジェクトをScratch風のJSON文字列に変換する
 */
function jsonToScratchString(obj) {
    let parts = [];
    for (const key in obj) {
        // 値が文字列の場合はエスケープとクォート処理を行う
        const value = typeof obj[key] === 'string' 
            ? `"${obj[key].replace(/\\/g, '\\\\').replace(/"/g, '\\"')}"` 
            : obj[key];
        
        // キーをクォートし、キーと値を結合
        parts.push(`"${key}":${value}`);
    }
    return `{${parts.join(',')}}`;
}


/**
 * ユーザー情報とプロジェクト情報を組み合わせて出力するヘルパー関数
 */
function renderOutput(userResult, projectResult, agentData, originalUsername, originalProjectId) {
    let userOutput = {};
    let projectOutput = {};
    let finalOutputText = '';
    
    // ----------------- 1. ユーザー情報 (JSON形式) -----------------
    if (originalUsername) { 
        if (userResult.status === 'NotFound') {
            userOutput.username = 'NotFound';
        } else if (userResult.status === 'Invalid') {
            userOutput.username = '無効'; // 修正1: 無効の印
        } else if (userResult.status === 'Success') {
            const userData = userResult.data;
            userOutput.username = userData.username;
            userOutput.id = userData.id;
            // 日付形式をYYYY-MM-DDに変換
            userOutput.joined = userData.history.joined ? new Date(userData.history.joined).toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-') : '-';
            userOutput.country = userData.profile.country || '-';
            // URLからクエリパラメータを除去
            userOutput.images = userData.profile.images['90x90'] ? userData.profile.images['90x90'].split('?')[0] : '-';
            
            // デバイス/ブラウザ情報はプロジェクトIDがある場合のみ取得される
            userOutput.device = agentData.device || '-';
            userOutput.browser = agentData.browser || '-';
        }

        if (Object.keys(userOutput).length > 0) {
            finalOutputText += jsonToScratchString(userOutput); // 修正5: JSON形式
        }
    }
    
    // ----------------- 2. プロジェクト情報 (JSON形式) -----------------
    if (originalProjectId) {
        if (projectResult.status === 'NotFound') {
            projectOutput.project_id = 'NotFound'; // 修正3: NotFoundの印
        } else if (projectResult.status === 'Invalid') {
            projectOutput.project_id = '無効'; // 修正3: 無効の印
        } else if (projectResult.status === 'Success') {
            const projectData = projectResult.data;
            projectOutput.project_id = projectData.id;
            projectOutput.title = projectData.title || '-';
            projectOutput.visibility = projectData.visibility || '-';
            projectOutput.author = projectData.author || '-';

            // ユザネクエリがない場合、プロジェクト側でデバイス/ブラウザを表示する
            if (!originalUsername) {
                 projectOutput.device = agentData.device || '-';
                 projectOutput.browser = agentData.browser || '-';
            }
        }

        if (Object.keys(projectOutput).length > 0) {
            if (finalOutputText.length > 0) finalOutputText += '<br>';
            finalOutputText += jsonToScratchString(projectOutput); // 修正5: JSON形式
        }
    }
    
    // ----------------- 3. 最終出力処理 -----------------
    if (finalOutputText.length === 0 && (originalUsername || originalProjectId)) {
        $output.text('NotFound'); 
        $output.css('display', 'block');
        logToScreen('[END] Output: NotFound (No data successfully fetched).');
    } else if (finalOutputText.length > 0) {
        $output.html(finalOutputText);
        $output.css('display', 'block');
        logToScreen('[END] Output successful.');
    }
    
    // 修正4: ユザネ側の応答がかき消されないように、独立したJSONとして出力されている
}

/**
 * プロジェクトIDからデバイス/ブラウザ情報を取得する
 */
function analyzeProjectAgent(projectId) {
    logToScreen(`4. Start Project Agent Analysis for ID: ${projectId}`);
    let deviceOutput = '';
    let browserOutput = '';
    
    return $.ajax({
        url: TURBOWARP_PROJECT_PROXY_BASE + projectId,
        dataType: "json",
    })
    .then(function (tokenData) {
        // プロジェクトトークン取得APIのエラーチェック
        if (tokenData.error) {
            logToScreen('4a. Project Token JSON Error. Skipping Agent Analysis.', true);
            // エラー時も空のデータを返すことで、メインの処理を止めない
            return $.Deferred().reject('Token JSON Error').promise();
        }

        logToScreen('4a. Project Token fetched.');
        let token = tokenData["project_token"];
        
        return $.ajax({
            url: `https://projects.scratch.mit.edu/${projectId}/?token=${token}`,
            dataType: "text",
        });
    })
    .then(function (projectJson) {
        logToScreen('4b. Project JSON fetched. Analyzing User-Agent.');
        const agentRegex = /"agent"\s*:\s*"(.+?)"/s;
        const match = projectJson.match(agentRegex);
        
        if (match && match[1]) {
            const userAgent = match[1];
            
             if (/Windows NT 10.0/.test(userAgent)) { deviceOutput = 'Windows 10/11'; } 
            else if (/iPhone/.test(userAgent)) { deviceOutput = 'iPhone (iOS)'; } 
            else if (/iPad/.test(userAgent)) { deviceOutput = 'iPad (iPadOS)'; } 
            else if (/Mac OS X/.test(userAgent) && !/iPhone|iPad/.test(userAgent)) { deviceOutput = 'Mac (macOS)'; } 
            else if (/Android/.test(userAgent)) { deviceOutput = 'Android'; } 
            else if (/Linux/.test(userAgent)) { deviceOutput = 'Linux'; }
            
            if (/CriOS\/(\d+\.\d+)/.test(userAgent)) { browserOutput = 'Chrome for iOS (CriOS)'; } 
            else if (/Edg\/(\d+\.\d+)/.test(userAgent)) { browserOutput = 'Edge'; } 
            else if (/Chrome\/(\d+\.\d+)/.test(userAgent)) { browserOutput = 'Chrome'; } 
            else if (/Safari\/(\d+\.\d+)/.test(userAgent) && !/Chrome|CriOS/.test(userAgent)) { browserOutput = 'Safari'; } 
            else if (/Firefox\/(\d+\.\d+)/.test(userAgent)) { browserOutput = 'Firefox'; }
        }
        return { device: deviceOutput, browser: browserOutput };
    })
    .catch(function(error) {
        logToScreen(`4. Project Agent Analysis failed. Error Status: ${error.statusText || 'Unknown'}`, true);
        return { device: '', browser: '' }; 
    });
}

/**
 * プロジェクトIDからメタデータを取得する (作者名を含む)
 */
function getProjectMetaData(projectId) {
    logToScreen(`2. Start Project Meta Data fetch for ID: ${projectId}`);
    return $.ajax({
        url: `https://api.scratch.mit.edu/projects/${projectId}`, 
        dataType: 'json',
    })
    .then(function(response) {
        logToScreen('2a. Project Meta Data API success.');
        
        // 修正3: JSONエラーのチェック
        if (response.error === 'Resource does not exist') {
             return { status: 'NotFound', source: 'project' };
        }
        if (response.error === 'Invalid project ID') {
             return { status: 'Invalid', source: 'project' };
        }
        
        return {
            data: {
                id: response.id,
                title: response.title,
                visibility: response.visibility,
                author: response.author ? response.author.username : null
            },
            status: 'Success', 
            source: 'project' 
        };
    })
    .catch(function(error) {
        logToScreen(`2. Project Meta Data API failed. Status: ${error.status || 'N/A'}, StatusText: ${error.statusText || 'Unknown'}`, true);
        return { status: 'Error', source: 'project' }; 
    });
}

/**
 * ユーザーIDからユーザー情報を取得する
 */
function getUserData(username) {
    logToScreen(`1. Start User Data fetch for user: ${username}`);
    return $.ajax({
        url: TURBOWARP_USER_PROXY_BASE + username,
        dataType: 'json',
    })
    .then(function(userData) {
        logToScreen('1a. User Data API success.');
        
        // 修正1: JSONエラーのチェックとステータスの分離
        if (userData.error === 'Resource does not exist') {
            return { status: 'NotFound', source: 'user' };
        }
        if (userData.error === 'Invalid username') {
            return { status: 'Invalid', source: 'user' };
        }
        
        return { data: userData, status: 'Success', source: 'user' };
    })
    .catch(function(reason) {
        const status = reason && reason.status ? reason.status : 'N/A';
        
        // 修正1: HTTPエラーのチェックとステータスの分離
        if (status === 404 || status === 400) {
            return { status: 'NotFound', source: 'user' };
        }
        
        logToScreen(`1d. Unhandled User API Error. Status: ${status}.`, true);
        return { status: 'Error', source: 'user' };
    });
}


/**
 * メインのデータ取得ロジック
 */
function loadAndAnalyzeData(username, projectId) {
    logToScreen(`[START] Analyzing Data (User: ${username || 'N/A'}, Project: ${projectId || 'N/A'})`);
    
    // ユーザー情報とプロジェクトメタデータのPromiseを作成
    let userPromise = username ? getUserData(username) : $.Deferred().resolve(null).promise();
    let projectMetaPromise = projectId ? getProjectMetaData(projectId) : $.Deferred().resolve(null).promise();
    let agentPromise = $.Deferred().resolve({ device: '', browser: '' }).promise();
    
    // ユーザー情報とプロジェクトメタデータの取得を待つ
    $.when(userPromise, projectMetaPromise)
    .then(function(userResult, projectResult) {
        let finalUserResult = userResult;
        
        // 3. ユザネの補完ロジック (userクエリがない場合のみ)
        if (!username && projectResult && projectResult.status === 'Success' && projectResult.data.author) {
            logToScreen(`3. Project author found. Fetching User Data for: ${projectResult.data.author}`);
            // プロジェクト作者のユーザー情報を取得する
            return $.when(getUserData(projectResult.data.author), projectResult);
        }
        
        // エージェント解析のPromiseを設定
        if (projectId && projectResult && projectResult.status === 'Success') {
            agentPromise = analyzeProjectAgent(projectId);
        }

        return $.when(finalUserResult, projectResult, agentPromise);
    })
    .then(function(userResult, projectResult, agentData) {
        // ステップ3で再取得した場合、userResultは新しい結果となる
        const finalAgentData = Array.isArray(agentData) ? agentData[0] : agentData; 
        
        logToScreen('[UPDATE] All data collected. Final rendering.');
        
        // 修正4 & 5: 独立したJSONとして結果を出力
        renderOutput(userResult, projectResult, finalAgentData, username, projectId);
    })
    .catch(function(reason) {
        // 処理できない致命的なエラー (ネットワークエラーなど) が発生した場合
        logToScreen(`[FATAL] A required API call failed. Reason: ${reason}. Displaying 'error'.`, true);
        $output.text('error');
        $output.css('display', 'block');
    });
}


// 3. ページロード時に処理を開始
$(document).ready(function() {
  document.title = window.location.hostname;
  
  const params = getQueryParameters();
  
  if (params.username || params.projectId) {
    loadAndAnalyzeData(params.username, params.projectId);
  } else {
    // クエリがない場合、Not entered! を表示し、表示を解除する
    $output.text('Not entered!');
    $output.css('display', 'block');
    logToScreen('[END] Blocked: No user or project ID provided. Displaying "Not entered!".');
  }
});
  </script>
</body>
</html>
