<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title></title> 
  
  <style>
    body {
      margin: 0;
      font-family: "Helvetica Neue", "Helvetica", Arial, sans-serif;
      color: #000; /* 全体を黒文字に */
      line-height: 1.5em;
      font-size: 16px; /* 文字を小さく */
      background-color: white; 
    }

    #container {
      width: auto;
      margin: 0;
      padding: 10px;
    }

    #result-output {
      white-space: pre-wrap; /* <br>を有効にし、改行を維持 */
      padding: 0;
      border: none;
      background-color: transparent;
      color: #000;
    }
    
    /* プロフィール画像は非表示 */
    #profile-image {
      display: none;
    }
  </style>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>
<body>
  <div id="container">
    <p id="result-output">データを読み込み中です...</p>
  </div>

  <script>
"use strict";

const API_BASE = 'https://api.scratch.mit.edu/users/';

/**
 * URLクエリから 'user' パラメータの値 (ユーザー名) を取得する関数
 * @returns {string | null} ユーザー名、または見つからなかった場合は null
 */
function getUsernameFromUrl() {
  const urlParams = new URLSearchParams(window.location.search);
  
  // ?user=<ユーザー名> から取得し、トリミング
  const username = urlParams.get('user');
  
  if (username) {
    return username.trim();
  }
  
  return null;
}

/**
 * 最新プロジェクトのJSONからUser-Agentを分析する非同期関数 (Callback使用)
 * @param {string} projectId - プロジェクトID
 * @param {function(string, string)} callback - 実行後に呼び出すコールバック関数 (device, browser)
 */
function analyzeProjectAgent(projectId, callback) {
    let deviceOutput = '';
    let browserOutput = '';

    // 1. トークン取得 (TurboWarp Proxy)
    $.ajax({
        url: `https://trampoline.turbowarp.org/proxy/projects/${projectId}`,
        dataType: "json",
        success: function (tokenData) {
            let token = tokenData["project_token"];
            
            // 2. プロジェクトJSON取得 (Agent情報)
            $.ajax({
                url: `https://projects.scratch.mit.edu/${projectId}/?token=${token}`,
                data: "",
                dataType: "text",
                success: function (projectJson) {
                    const agentRegex = /"agent"\s*:\s*"(.+?)"/s;
                    const match = projectJson.match(agentRegex);
                    
                    if (match && match[1]) {
                        const userAgent = match[1];
                        
                        // OS/Browser analysis logic
                        if (/Windows NT 10.0/.test(userAgent)) {
                            deviceOutput = 'Windows 10/11';
                        } else if (/iPhone/.test(userAgent)) {
                            deviceOutput = 'iPhone (iOS)';
                        } else if (/iPad/.test(userAgent)) {
                            deviceOutput = 'iPad (iPadOS)';
                        } else if (/Mac OS X/.test(userAgent) && !/iPhone|iPad/.test(userAgent)) {
                            deviceOutput = 'Mac (macOS)';
                        } else if (/Android/.test(userAgent)) {
                            deviceOutput = 'Android';
                        } else if (/Linux/.test(userAgent)) {
                            deviceOutput = 'Linux';
                        }
                        
                        if (/CriOS\/(\d+\.\d+)/.test(userAgent)) {
                            browserOutput = 'Chrome for iOS (CriOS)';
                        } else if (/Edg\/(\d+\.\d+)/.test(userAgent)) {
                            browserOutput = 'Edge';
                        } else if (/Chrome\/(\d+\.\d+)/.test(userAgent)) {
                            browserOutput = 'Chrome';
                        } else if (/Safari\/(\d+\.\d+)/.test(userAgent) && !/Chrome|CriOS/.test(userAgent)) {
                            browserOutput = 'Safari';
                        } else if (/Firefox\/(\d+\.\d+)/.test(userAgent)) {
                            browserOutput = 'Firefox';
                        }
                    }
                    callback(deviceOutput, browserOutput);
                },
                error: function() {
                    // JSON取得失敗は空白で処理
                    callback(deviceOutput, browserOutput);
                }
            });
        },
        error: function() {
            // トークン取得失敗は空白で処理
            callback(deviceOutput, browserOutput);
        }
    });
}


/**
 * ユーザー情報、未読数、デバイス情報を連続して取得し、結果を出力するメイン関数
 * @param {string} username - Scratchのユーザー名
 */
function loadAndAnalyzeUser(username) {
    const $output = $('#result-output');
    
    // --- 1. ユーザー情報 API (1st API) ---
    $.ajax({
        url: API_BASE + username,
        dataType: 'json',
        success: function(userData) {
            
            // --- 無効な入力チェック (Not entered!) ---
            if (userData.code === 'ResourceNotFound') {
                // 無入力または空文字列をAPIが受け取った場合
                $output.text('Not entered!');
                return;
            }
            
            // --- ユーザー存在チェック (NotFound) ---
            if (userData.code === 'NotFound') {
                $output.text('NotFound');
                return;
            }
            
            // 正常なユーザーデータの抽出
            const userName = userData.username || 'N/A';
            const userId = userData.id || 'N/A';
            const joinedDate = userData.history.joined ? new Date(userData.history.joined).toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-') : 'N/A';
            const country = userData.profile.country || 'N/A';
            const imageUrl = userData.profile.images['90x90'] || ''; // 画像URLは表示しないが保持

            let messageCount = '取得中...';
            let latestProjectId = null;
            let deviceOutput = '';
            let browserOutput = '';

            // --- 2. メッセージ数 API (2nd API) ---
            $.ajax({
                url: API_BASE + username + '/messages/count',
                dataType: 'json',
                success: function(countData) {
                    messageCount = countData.count !== undefined ? countData.count : 'N/A';
                },
                error: function() {
                    messageCount = '取得失敗';
                },
                complete: function() {
                    
                    // --- 3. プロジェクト API (3rd API) ---
                    $.ajax({
                        url: API_BASE + username + '/projects/?limit=1&offset=0',
                        dataType: 'json',
                        success: function(projectsData) {
                            if (Array.isArray(projectsData) && projectsData.length > 0) {
                                latestProjectId = projectsData[0].id;
                                
                                // --- 4. デバイス/ブラウザ解析 ---
                                analyzeProjectAgent(latestProjectId, function(device, browser) {
                                    deviceOutput = device;
                                    browserOutput = browser;
                                    
                                    // 最終出力
                                    generateOutput();
                                });
                                
                            } else {
                                // 作品がない場合 (デバイス/ブラウザは空欄のまま)
                                generateOutput();
                            }
                        },
                        error: function() {
                            // プロジェクトリスト取得失敗 (デバイス/ブラウザは空欄のまま)
                            generateOutput();
                        }
                    });
                }
            });
            
            // --- 最終結果の結合と出力関数 ---
            function generateOutput() {
                let outputText = '';

                // ユーザー情報
                outputText += `username: ${userName}<br>`;
                outputText += `id: ${userId}<br>`;
                outputText += `joined: ${joinedDate}<br>`;
                outputText += `country: ${country}<br>`;
                outputText += `images: ${imageUrl}<br>`;
                outputText += `Unread count: ${messageCount}`;
                
                // デバイス/ブラウザ情報がある場合のみ追記
                if (deviceOutput) {
                    outputText += `<br>device: ${deviceOutput}`;
                }
                if (browserOutput) {
                    outputText += `<br>browser: ${browserOutput}`;
                }

                $output.html(outputText);
            }

        },
        error: function(xhr, status, error) {
            // ユーザー情報API自体がネットワークレベルで失敗した場合
            $output.text('error');
        }
    });
}


// 3. ページロード時に処理を開始
$(document).ready(function() {
  // ページタイトルをURL名（ホスト名）に設定
  document.title = window.location.hostname;
  
  const username = getUsernameFromUrl();
  
  if (username && username.length > 0) {
    // ユーザー名があれば自動でロード・分析を開始
    loadAndAnalyzeUser(username);
  } else {
    // ユーザー名がない、または空文字列の場合
    $('#result-output').html('Not entered!');
  }
});
  </script>
</body>
</html>
