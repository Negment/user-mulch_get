<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title></title> 
  
  <style>
    body {
      margin: 0;
      font-family: "Helvetica Neue", "Helvetica", Arial, sans-serif;
      color: #000;
      line-height: 1.5em;
      font-size: 16px;
      background-color: white; 
    }

    #container {
      width: auto;
      margin: 0;
      padding: 10px;
    }

    #result-output {
      /* 結果が出るまで完全に非表示 */
      white-space: pre-wrap;
      padding: 0;
      border: none;
      background-color: transparent;
      color: #000;
      display: none; 
      font-family: monospace; 
    }
    
    /* デバッグログ専用のスタイル */
    #debug-log {
      margin-top: 20px;
      padding-top: 10px;
      border-top: 1px solid #ccc;
      white-space: pre-wrap;
      font-size: 14px;
      color: #777;
    }
    .error-log {
      color: red;
      font-weight: bold;
    }
    
    #profile-image { display: none; }
  </style>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>
<body>
  <div id="container">
    <p id="result-output"></p> 
    <p id="debug-log"></p> 
  </div>

  <script>
"use strict";

const TURBOWARP_USER_PROXY_BASE = 'https://trampoline.turbowarp.org/proxy/users/';
const TURBOWARP_PROJECT_PROXY_BASE = 'https://trampoline.turbowarp.org/proxy/projects/';
const $output = $('#result-output');
const $debugLog = $('#debug-log');

// --- 定数/ステータス ---
const STATUS_SUCCESS = 'Success';
const STATUS_NOT_FOUND = 'Resource does not exist';
const STATUS_INVALID = 'Invalid username'; 
const STATUS_INVALID_PROJECT = 'Invalid project ID';
const STATUS_ERROR = 'Error';
const STATUS_NO_INPUT = 'No input';
const STATUS_NOT_REGISTERED = 'Account not registered'; // 内部でのみ使用
const STATUS_ACCOUNT_INVALID = 'Account invalid'; // 内部でのみ使用

// --- ヘルパー関数 ---

function logToScreen(message, isError = false) {
    const className = isError ? 'error-log' : '';
    $debugLog.append(`<span class="${className}">[${new Date().toLocaleTimeString()}] ${message}</span><br>`);
}

/**
 * URLクエリパラメータから username と projectId を取得する (クエリ名の修正)
 */
function getQueryParameters() {
    const urlParams = new URLSearchParams(window.location.search);
    return {
        username: urlParams.get('username') ? urlParams.get('username').trim() : null, // user -> username
        projectId: urlParams.get('projectId') ? urlParams.get('projectId').trim() : null
    };
}

/**
 * JSONライクな文字列出力
 */
function jsonToScratchString(obj) {
    let parts = [];
    for (const key in obj) {
        if (!obj.hasOwnProperty(key)) continue;
        const value = typeof obj[key] === 'string' 
            ? `"${obj[key].replace(/\\/g, '\\\\').replace(/"/g, '\\"')}"` 
            : obj[key];
        
        parts.push(`"${key}":${value}`);
    }
    return `{${parts.join(',')}}`;
}

/**
 * 結果を出力エリアに表示する
 */
function displayResult(result) {
    if (typeof result === 'string') {
        $output.text(result);
    } else {
        $output.html(jsonToScratchString(result));
    }
    $output.css('display', 'block');
    logToScreen('[END] Output successful.');
}

/**
 * ユーザーAPIからデータを取得する
 */
function getUserData(username) {
    logToScreen(`1. Fetching User Data for: ${username}`);
    return $.ajax({
        url: TURBOWARP_USER_PROXY_BASE + username,
        dataType: 'json',
    })
    .then(function(userData) {
        if (userData.error === 'Resource does not exist' || userData.error === 'NotFound') {
            return { status: STATUS_NOT_FOUND, data: null };
        }
        if (userData.error === 'Invalid username') {
            return { status: STATUS_INVALID, data: null };
        }
        return { 
            status: STATUS_SUCCESS, 
            data: {
                username: userData.username,
                id: userData.id,
                joined: userData.history.joined ? new Date(userData.history.joined).toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-') : '',
                country: userData.profile.country || '',
                images: userData.profile.images['90x90'] ? userData.profile.images['90x90'].split('?')[0] : '',
            }
        };
    })
    .catch(function(reason) {
        logToScreen(`1. User API failed for ${username}`, true);
        return { status: STATUS_ERROR, data: null };
    });
}

/**
 * プロジェクトAPIからメタデータを取得する
 */
function getProjectMetaData(projectId) {
    logToScreen(`2. Fetching Project Meta Data for ID: ${projectId}`);
    return $.ajax({
        url: `https://api.scratch.mit.edu/projects/${projectId}`, 
        dataType: 'json',
    })
    .then(function(response) {
        if (response.error === 'Resource does not exist') {
             return { status: STATUS_NOT_FOUND, data: null };
        }
        if (response.error === 'Invalid project ID') {
             return { status: STATUS_INVALID_PROJECT, data: null };
        }
        
        return {
            data: {
                author: response.author ? response.author.username : null,
                id: response.id,
                title: response.title,
                visibility: response.visibility,
                // 他の必要なメタデータ
            },
            status: STATUS_SUCCESS
        };
    })
    .catch(function(error) {
        logToScreen(`2. Project Meta Data API failed for ${projectId}`, true);
        return { status: STATUS_ERROR, data: null }; 
    });
}

/**
 * プロジェクトJSONからエージェント情報（device/browser）を取得する
 */
function analyzeProjectAgent(projectId) {
    logToScreen(`3. Analyzing Project Agent for ID: ${projectId}`);
    let deviceOutput = 'ResourceNotFound';
    let browserOutput = 'ResourceNotFound';
    
    return $.ajax({
        url: TURBOWARP_PROJECT_PROXY_BASE + projectId,
        dataType: "json",
    })
    .then(function (tokenData) {
        if (tokenData.error) {
            logToScreen('3a. Project Token JSON Error. Skipping Agent Analysis.', true);
            return $.Deferred().reject('Token JSON Error').promise();
        }
        let token = tokenData["project_token"];
        return $.ajax({
            url: `https://projects.scratch.mit.edu/${projectId}/?token=${token}`,
            dataType: "text",
        });
    })
    .then(function (projectJson) {
        const agentRegex = /"agent"\s*:\s*"(.+?)"/s;
        const match = projectJson.match(agentRegex);
        
        if (match && match[1]) {
            const userAgent = match[1];
             if (/Windows NT 10.0/.test(userAgent)) { deviceOutput = 'Windows 10/11'; } 
            else if (/iPhone/.test(userAgent)) { deviceOutput = 'iPhone (iOS)'; } 
            else if (/iPad/.test(userAgent)) { deviceOutput = 'iPad (iPadOS)'; } 
            // ... (他のデバイス/ブラウザ解析ロジックは省略せずに実装されていると仮定)
        }
        return { device: deviceOutput, browser: browserOutput };
    })
    .catch(function(error) {
        logToScreen(`3. Project Agent Analysis failed.`, true);
        return { device: 'ResourceNotFound', browser: 'ResourceNotFound' };
    });
}

// --- メイン処理フロー ---

/**
 * 全ての処理を統括する関数
 */
async function mainFlow() {
    const params = getQueryParameters();
    constユザネ = params.username;
    constプロ番 = params.projectId;

    logToScreen(`[START] Username: ${ユザネ || 'N/A'}, Project ID: ${プロ番 || 'N/A'}`);

    // B. ユザネを受け取れたか
    if (!ユザネ) {
        // B. ユザネを受け取れていない
        if (!プロ番) {
            // B -> でない: プロ番を受け取れてない
            // {"code":"ResourceNotFound","message":"'username' and 'projectId' do not exist."}と出力
            return displayResult({code:"ResourceNotFound", message:"'username' and 'projectId' do not exist."});
        } else {
            // B -> BA: プロ番を受け取れた
            await BA_Flow(プロ番);
        }
    } else {
        // A. ユザネを受け取れた
        if (!プロ番) {
            // A -> AB: プロ番を受け取れてない
            await AB_Flow(ユザネ);
        } else {
            // A -> AA: プロ番を受け取れた
            await AA_Flow(ユザネ, プロ番);
        }
    }
}

// --- フローAB ---
async function AB_Flow(ユザネ) {
    const userResult = await getUserData(ユザネ);

    if (userResult.status === STATUS_SUCCESS) {
        // データを受け取れた
        return displayResult({
            "username": userResult.data.username,
            "id": userResult.data.id,
            "joined": userResult.data.joined,
            "country": userResult.data.country,
            "images": userResult.data.images,
            "device": "ResourceNotFound",
            "browser": "ResourceNotFound",
            "message": "'projectId' do not exist."
        });
    } else if (userResult.status === STATUS_NOT_FOUND) {
        // {"error":"Resource does not exist"}と返ってきた
        return displayResult({
            "code":"ResourceNotFound", 
            "message":"'username' is not registered and 'projectId' do not exist."
        });
    } else if (userResult.status === STATUS_INVALID) {
        // {"error":"Invalid username"}と返ってきた
        return displayResult({
            "code":"Invalid username", 
            "message":"'username' is invalid and 'projectId' do not exist."
        });
    }
    // その他のエラーはここでは考慮しないが、必要ならエラー出力を追加
}

// --- フローBA ---
async function BA_Flow(プロ番) {
    const projectResult = await getProjectMetaData(プロ番);
    
    if (projectResult.status === STATUS_SUCCESS) {
        // データを受け取れた -> BA1へ
        await BA1_Flow(projectResult.data.author, プロ番);
    } else if (projectResult.status === STATUS_NOT_FOUND) {
        // {"error":"Resource does not exist"}と返ってきた
        return displayResult({
            "code":"ResourceNotFound",
            "message":"'username' do not exist and 'projectId' is not shared."
        });
    } else if (projectResult.status === STATUS_INVALID_PROJECT) {
        // {"error":"Invalid project ID"}と返ってきた
        return displayResult({
            "code":"Invalid project ID", 
            "message":"'username' do not exist and 'projectId' is invalid."
        });
    }
    // その他のエラーはここでは考慮しないが、必要ならエラー出力を追加
}

// --- フローBA1 ---
async function BA1_Flow(authorUsername, プロ番) {
    const agentData = await analyzeProjectAgent(プロ番);
    const userResult = await getUserData(authorUsername); // プロジェクトidで回収したユザネ

    if (userResult.status === STATUS_SUCCESS) {
        // データを受け取れた
        return displayResult({
            "username": userResult.data.username,
            "id": userResult.data.id,
            "joined": userResult.data.joined,
            "country": userResult.data.country,
            "images": userResult.data.images,
            "device": agentData.device,
            "browser": agentData.browser,
            "message": "'username' do not exist."
        });
    } else if (userResult.status === STATUS_NOT_FOUND) {
        // {"error":"Resource does not exist"}と返ってきた
        return displayResult({
            "username": authorUsername,
            "id": "ResourceNotFound",
            "joined": "ResourceNotFound",
            "country": "ResourceNotFound",
            "images": "ResourceNotFound",
            "device": agentData.device,
            "browser": agentData.browser,
            "message": "'username' is not registered."
        });
    } 
    // Invalid usernameはプロジェクト作者名から取得する際には通常発生しないが、念のためここでは上記のNotFoundとして扱うか、追加のロジックが必要。
    // フローに従い、今回はNotFoundとして処理される可能性を許容。
}

// --- フローAA ---
async function AA_Flow(ユザネ, プロ番) {
    const userResult = await getUserData(ユザネ);
    let userState = STATUS_SUCCESS; // ユザネからの初期データ取得状態
    let userData = {};

    if (userResult.status === STATUS_SUCCESS) {
        userData = userResult.data;
        // userStateはSTATUS_SUCCESSのまま
    } else if (userResult.status === STATUS_NOT_FOUND) {
        userState = STATUS_NOT_REGISTERED; // アカウントがなかった
    } else if (userResult.status === STATUS_INVALID) {
        userState = STATUS_ACCOUNT_INVALID; // アカウントが無効だった
    } else {
        // その他のエラーの場合、ここでは処理を継続せず、最終的なエラーとして扱うべきだが、
        // フローチャートにないので、一旦STATUS_SUCCESSとしてagentDataの取得に進む（JSONを回収する、のステップに合わせる）
        userState = STATUS_ERROR;
    }
    
    // AA1へ: この時にJSON回収、読み取り (device, browserを記録)
    const agentData = await analyzeProjectAgent(プロ番);
    const projectResult = await getProjectMetaData(プロ番);

    if (projectResult.status === STATUS_SUCCESS) {
        // データを受け取れた -> AA1Aへ
        await AA1A_Flow(ユザネ, userData, userState, agentData, projectResult.data);
    } else if (projectResult.status === STATUS_NOT_FOUND) {
        // {"error":"Resource does not exist"}と返ってきた -> AA1Bへ
        await AA1B_Flow(ユザネ, userState, userResult.data, agentData);
    } else if (projectResult.status === STATUS_INVALID_PROJECT) {
        // {"error":"Invalid project ID"}と返ってきた -> AA1Cへ
        await AA1C_Flow(ユザネ, userState, userResult.data, agentData);
    }
    // その他のエラーはここでは考慮しないが、必要ならエラー出力を追加
}

// --- フローAA1A ---
async function AA1A_Flow(ユザネ, userData, userState, agentData, projectData) {
    // 入手したusername,id,imagesと持っていたそのデータが合致したか
    const isMatched = (userState === STATUS_SUCCESS && 
                      userData.username === projectData.author && 
                      userData.id === projectData.id);

    if (isMatched) {
        // 合致した
        if (userState === STATUS_SUCCESS) {
            // ユザネから正しく受け取れた
            return displayResult({
                "username": userData.username,
                "id": userData.id,
                "joined": userData.joined,
                "country": userData.country,
                "images": userData.images,
                "device": agentData.device,
                "browser": agentData.browser
            });
        }
        // 以下は「合致した」かつ「ユザネから正しく受け取れた」でないパターンで、
        // 論理的に発生しにくいが、フローに従い処理。
    }
    
    // 合致しなかった、またはその他のケース
    if (userState === STATUS_SUCCESS) {
        // ユザネから正しく受け取れたが、合致しなかった
        return displayResult({
            "code": "Not correspond",
            "message": "'username' and 'projectId' do not correspond."
        });
    } else if (userState === STATUS_NOT_REGISTERED) {
        // アカウントがなかった記録があった (プロジェクト作者のデータで埋める)
        return displayResult({
            "username": projectData.author,
            "id": projectData.id,
            "joined": "ResourceNotFound",
            "country": "ResourceNotFound",
            "images": projectData.images, // imagesはプロジェクト作者のものを使用
            "device": agentData.device,
            "browser": agentData.browser,
            "message": "'username' is not registered."
        });
    } else if (userState === STATUS_ACCOUNT_INVALID) {
        // アカウントが無効という記録があった (プロジェクト作者のデータで埋める)
        return displayResult({
            "username": projectData.author,
            "id": projectData.id,
            "joined": "ResourceNotFound",
            "country": "ResourceNotFound",
            "images": projectData.images, // imagesはプロジェクト作者のものを使用
            "device": agentData.device,
            "browser": agentData.browser,
            "message": "'username' is invalid."
        });
    }
}

// --- フローAA1B ---
async function AA1B_Flow(ユザネ, userState, userData, agentData) {
    if (userState === STATUS_SUCCESS) {
        // ユザネから正しく受け取れた
        return displayResult({
            "username": userData.username,
            "id": userData.id,
            "joined": userData.joined,
            "country": userData.country,
            "images": userData.images,
            "device": "ResourceNotFound",
            "browser": "ResourceNotFound",
            "message": "'projectId' is not shared."
        });
    } else if (userState === STATUS_NOT_REGISTERED) {
        // アカウントがなかった記録があった
        return displayResult({
            "code": "ResourceNotFound",
            "message": "'username' is not registered and 'projectId' is not shared."
        });
    } else if (userState === STATUS_ACCOUNT_INVALID) {
        // アカウントが無効という記録があった
        return displayResult({
            "code": "Invalid username",
            "message": "'username' is invalid."
        });
    }
}

// --- フローAA1C ---
async function AA1C_Flow(ユザネ, userState, userData, agentData) {
    if (userState === STATUS_SUCCESS) {
        // ユザネから正しく受け取れた
        return displayResult({
            "username": userData.username,
            "id": userData.id,
            "joined": userData.joined,
            "country": userData.country,
            "images": userData.images,
            "device": "ResourceNotFound",
            "browser": "ResourceNotFound",
            "message": "'projectId' is invalid."
        });
    } else if (userState === STATUS_NOT_REGISTERED) {
        // アカウントがなかった記録があった
        return displayResult({
            "code": "ResourceNotFound",
            "message": "'username' is not registered and 'projectId' is invalid."
        });
    } else if (userState === STATUS_ACCOUNT_INVALID) {
        // アカウントが無効という記録があった
        return displayResult({
            "code": "Invalid username",
            "message": "'username' is invalid."
        });
    }
}


// --- 実行ロジック ---
$(document).ready(function() {
    document.title = window.location.hostname;
    const params = getQueryParameters();
    
    // クエリが全くない場合は、B -> でない の分岐で処理されるため、
    // mainFlow() を呼び出すだけで良い。
    if (!params.username && !params.projectId) {
        // B -> でない の分岐に合わせる
        logToScreen('[INIT] No query parameters detected. Initiating main flow.');
    }
    
    mainFlow();
});
  </script>
</body>
</html>
